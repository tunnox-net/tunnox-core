graph TB
    %% 应用层 (Application Layer)
    subgraph AL["应用层 (Application Layer)"]
        style AL fill:#e1f5fe
        PF[ProtocolFactory<br/>协议工厂]
        S[Server<br/>服务器]
        M[Main<br/>主程序]
    end

    %% 协议层 (Protocol Layer)
    subgraph PL["协议层 (Protocol Layer)"]
        style PL fill:#f3e5f5
        TA[TCP Adapter<br/>TCP适配器]
        WA[WebSocket Adapter<br/>WebSocket适配器]
        UA[UDP Adapter<br/>UDP适配器]
        QA[QUIC Adapter<br/>QUIC适配器]
    end

    %% 会话层 (Session Layer)
    subgraph SL["会话层 (Session Layer)"]
        style SL fill:#e8f5e8
        CS[ConnectionSession<br/>连接会话]
        subgraph CS_INNER["会话组件"]
            CID[ConnectionID<br/>连接ID生成器]
            SM[StreamManager<br/>流管理器]
        end
    end

    %% 流管理层 (Stream Management Layer)
    subgraph SML["流管理层 (Stream Management Layer)"]
        style SML fill:#fff3e0
        STM[StreamManager<br/>流管理器]
        subgraph STM_INNER["管理组件"]
            SR[Stream Registry<br/>流注册表]
            SMF[Stream Metrics<br/>流指标]
        end
    end

    %% 工厂层 (Factory Layer)
    subgraph FL["工厂层 (Factory Layer)"]
        style FL fill:#fce4ec
        DSF[DefaultStreamFactory<br/>默认流工厂]
        CSF[ConfigurableStreamFactory<br/>可配置流工厂]
        SP[Stream Profiles<br/>流配置模板]
    end

    %% 实现层 (Implementation Layer)
    subgraph IL["实现层 (Implementation Layer)"]
        style IL fill:#f1f8e9
        SPROC[StreamProcessor<br/>流处理器]
        GZR[GzipReader<br/>压缩读取器]
        GZW[GzipWriter<br/>压缩写入器]
        RLR[RateLimiterReader<br/>限速读取器]
        RLW[RateLimiterWriter<br/>限速写入器]
        TB[TokenBucket<br/>令牌桶]
    end

    %% 连接关系
    %% 应用层到协议层
    PF --> TA
    PF --> WA
    PF --> UA
    PF --> QA

    %% 协议层到会话层
    TA --> CS
    WA --> CS
    UA --> CS
    QA --> CS

    %% 会话层内部
    CS --> CID
    CS --> SM

    %% 会话层到流管理层
    SM --> STM

    %% 流管理层内部
    STM --> SR
    STM --> SMF

    %% 流管理层到工厂层
    STM --> DSF
    STM --> CSF

    %% 工厂层内部
    CSF --> SP

    %% 工厂层到实现层
    DSF --> SPROC
    DSF --> GZR
    DSF --> GZW
    DSF --> RLR
    DSF --> RLW
    CSF --> SPROC
    CSF --> GZR
    CSF --> GZW
    CSF --> RLR
    CSF --> RLW

    %% 实现层内部依赖
    RLR --> TB
    RLW --> TB
    SPROC --> GZR
    SPROC --> GZW
    SPROC --> RLR
    SPROC --> RLW

    %% 样式定义
    classDef applicationLayer fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef protocolLayer fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef sessionLayer fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef streamManagementLayer fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef factoryLayer fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef implementationLayer fill:#f1f8e9,stroke:#33691e,stroke-width:2px

    %% 应用样式
    class PF,S,M applicationLayer
    class TA,WA,UA,QA protocolLayer
    class CS,CID,SM sessionLayer
    class STM,SR,SMF streamManagementLayer
    class DSF,CSF,SP factoryLayer
    class SPROC,GZR,GZW,RLR,RLW,TB implementationLayer 