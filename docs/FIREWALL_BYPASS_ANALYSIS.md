# HTTPPOLL 防火墙绕过分析

## 一、当前协议特征（易被识别）

### 1. URL路径特征（高风险）
- **特征**：`/tunnox/v1/push` 和 `/tunnox/v1/poll`
- **识别方式**：防火墙可以通过简单的URL匹配规则识别
- **风险等级**：⭐⭐⭐⭐⭐（极高）

### 2. HTTP头特征（高风险）
- **特征**：自定义HTTP头 `X-Tunnel-Package`
- **内容**：Base64编码的Gzip压缩JSON数据
- **识别方式**：
  - 防火墙可以检查是否存在自定义的`X-`开头的HTTP头
  - 可以解码Base64并解压Gzip，检查JSON内容
- **风险等级**：⭐⭐⭐⭐⭐（极高）

### 3. 请求体特征（高风险）
- **特征**：JSON格式的`FragmentResponse`结构
- **关键字段**：
  ```json
  {
    "fragment_group_id": "uuid",
    "fragment_index": 0,
    "total_fragments": 2,
    "sequence_number": 123,
    "data": "base64_encoded_data"
  }
  ```
- **识别方式**：防火墙可以通过JSON字段名识别分片传输协议
- **风险等级**：⭐⭐⭐⭐⭐（极高）

### 4. 请求模式特征（中风险）
- **特征**：
  - GET请求带`?timeout=30`参数
  - 长时间HTTP连接（30秒超时）
  - 频繁的Poll请求（长轮询模式）
- **识别方式**：防火墙可以通过行为分析识别长轮询模式
- **风险等级**：⭐⭐⭐（中等）

### 5. 缺少浏览器特征（中风险）
- **特征**：没有`User-Agent`、`Accept`、`Accept-Encoding`、`Referer`等常见浏览器头
- **识别方式**：防火墙可以识别非浏览器HTTP请求
- **风险等级**：⭐⭐⭐（中等）

### 6. 编码方式特征（低风险）
- **特征**：Base64 + Gzip压缩
- **识别方式**：防火墙可以检查数据编码模式
- **风险等级**：⭐⭐（低）

## 二、防火墙可能的识别方式

### 1. 深度包检测（DPI）
- **检查内容**：
  - URL路径匹配（`/tunnox/v1/*`）
  - HTTP头检查（`X-Tunnel-Package`）
  - 请求体内容分析（JSON字段名）
  - Base64解码和Gzip解压检查
- **识别准确度**：⭐⭐⭐⭐⭐（极高）

### 2. 行为分析
- **检查内容**：
  - 长时间HTTP连接（30秒超时）
  - 频繁的Poll请求模式
  - 请求/响应时间模式
  - 数据包大小分布
- **识别准确度**：⭐⭐⭐⭐（高）

### 3. 流量特征分析
- **检查内容**：
  - 请求频率
  - 数据包大小
  - 连接持续时间
  - 双向流量模式
- **识别准确度**：⭐⭐⭐（中等）

### 4. TLS/SSL检测（如果使用HTTPS）
- **检查内容**：
  - SNI（Server Name Indication）
  - 证书信息
  - TLS握手特征
- **识别准确度**：⭐⭐⭐（中等）

## 三、绕过方案

### 方案1：伪装URL路径（优先级：高）
**目标**：将可疑的URL路径改为常见的API路径

**实现**：
- 将 `/tunnox/v1/push` 改为 `/api/v1/notifications` 或 `/api/v1/messages`
- 将 `/tunnox/v1/poll` 改为 `/api/v1/events` 或 `/api/v1/subscriptions`
- 使用常见的RESTful API路径模式

**优点**：
- 实现简单
- 效果明显
- 不影响协议逻辑

**缺点**：
- 如果防火墙有白名单，仍可能被识别

### 方案2：伪装HTTP头（优先级：高）
**目标**：将自定义HTTP头改为常见的HTTP头，或将数据隐藏在常见头中

**实现选项**：
- **选项A**：使用常见的自定义头，如 `X-Request-ID`、`X-Correlation-ID`
- **选项B**：将数据隐藏在`Authorization`头的Bearer token中
- **选项C**：使用`Cookie`头传递数据
- **选项D**：将数据隐藏在`User-Agent`或`Referer`头中

**优点**：
- 可以完全隐藏自定义头
- 使用常见头可以降低被识别风险

**缺点**：
- 需要修改编码/解码逻辑
- 某些头有长度限制

### 方案3：伪装请求体格式（优先级：高）
**目标**：将分片数据格式改为常见的API请求/响应格式

**实现选项**：
- **选项A**：伪装成常见的API格式，如：
  ```json
  {
    "event": "message",
    "payload": "base64_encoded_data",
    "metadata": {
      "id": "uuid",
      "timestamp": 1234567890
    }
  }
  ```
- **选项B**：使用多部分表单数据（multipart/form-data）
- **选项C**：使用GraphQL格式
- **选项D**：将数据隐藏在图片或其他媒体文件中

**优点**：
- 可以完全隐藏分片传输特征
- 使用常见格式可以降低被识别风险

**缺点**：
- 需要修改序列化/反序列化逻辑
- 可能增加数据开销

### 方案4：添加浏览器特征（优先级：中）
**目标**：让HTTP请求看起来像浏览器请求

**实现**：
- 添加`User-Agent`：使用常见的浏览器User-Agent字符串
- 添加`Accept`：`text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8`
- 添加`Accept-Encoding`：`gzip, deflate, br`
- 添加`Accept-Language`：`en-US,en;q=0.9`
- 添加`Referer`：随机或固定的Referer URL
- 添加`Cache-Control`：`no-cache`
- 添加`Pragma`：`no-cache`

**优点**：
- 实现简单
- 可以降低被识别为非浏览器请求的风险

**缺点**：
- 如果防火墙有更高级的检测，仍可能被识别

### 方案5：改变请求模式（优先级：中）
**目标**：让长轮询模式看起来像正常的HTTP请求

**实现**：
- 随机化超时时间（20-40秒）
- 添加随机延迟
- 模拟正常的HTTP请求模式（如定期健康检查）
- 使用WebSocket升级请求（如果支持）

**优点**：
- 可以降低行为分析识别的风险

**缺点**：
- 可能影响协议性能
- 实现复杂度中等

### 方案6：数据混淆（优先级：低）
**目标**：混淆数据编码，使其看起来不像Base64+Gzip

**实现选项**：
- **选项A**：使用其他编码方式（如URL编码、十六进制编码）
- **选项B**：添加随机填充数据
- **选项C**：使用加密（AES）而不是简单的Base64编码
- **选项D**：使用Steganography（隐写术）将数据隐藏在图片或其他文件中

**优点**：
- 可以完全隐藏数据编码特征

**缺点**：
- 实现复杂度高
- 可能增加数据开销
- 性能影响

### 方案7：使用HTTPS + SNI伪装（优先级：中）
**目标**：如果使用HTTPS，伪装SNI和证书

**实现**：
- 使用常见的域名（如`api.example.com`）
- 使用有效的SSL证书
- 使用常见的TLS版本和密码套件

**优点**：
- 可以降低TLS检测识别的风险

**缺点**：
- 需要有效的域名和证书
- 如果防火墙有更高级的检测，仍可能被识别

## 四、推荐实施方案

### 阶段1：快速实施（立即生效）
1. **伪装URL路径**：改为常见的API路径
2. **添加浏览器特征**：添加User-Agent、Accept等头
3. **伪装HTTP头名称**：将`X-Tunnel-Package`改为`X-Request-ID`或隐藏在`Authorization`头中

### 阶段2：深度伪装（中期实施）
1. **伪装请求体格式**：改为常见的API格式
2. **改变请求模式**：随机化超时时间和添加随机延迟
3. **数据混淆**：使用加密而不是简单的Base64编码

### 阶段3：高级绕过（长期实施）
1. **使用Steganography**：将数据隐藏在图片或其他文件中
2. **使用WebSocket升级**：如果防火墙允许WebSocket
3. **使用CDN代理**：通过CDN代理隐藏真实服务器

## 五、技术实现建议

### 1. 配置化设计
- 将绕过策略设计为可配置的
- 支持多种绕过模式（简单模式、标准模式、高级模式）
- 允许动态切换绕过策略

### 2. 向后兼容
- 保持原有协议逻辑不变
- 只在传输层进行伪装
- 确保服务器端可以识别和处理伪装后的请求

### 3. 性能考虑
- 避免过度混淆导致性能下降
- 使用高效的编码/解码算法
- 尽量减少数据开销

### 4. 安全性
- 如果使用加密，确保密钥管理安全
- 避免在客户端硬编码绕过策略
- 支持动态更新绕过策略

## 六、风险评估

### 实施风险
- **低风险**：伪装URL路径、添加浏览器特征
- **中风险**：伪装HTTP头、改变请求模式
- **高风险**：数据混淆、Steganography

### 效果评估
- **高效果**：伪装URL路径、伪装HTTP头、伪装请求体格式
- **中效果**：添加浏览器特征、改变请求模式
- **低效果**：数据混淆（如果防火墙有更高级的检测）

## 七、测试建议

### 1. 功能测试
- 确保所有绕过策略不影响协议功能
- 测试各种绕过模式的兼容性
- 测试服务器端识别和处理伪装后的请求

### 2. 性能测试
- 测试绕过策略对性能的影响
- 测试数据开销
- 测试延迟影响

### 3. 安全测试
- 测试绕过策略的有效性
- 测试防火墙检测的规避效果
- 测试各种防火墙场景

## 八、总结

当前HTTPPOLL协议的主要识别特征：
1. **URL路径**（`/tunnox/v1/*`）- 极高风险
2. **HTTP头**（`X-Tunnel-Package`）- 极高风险
3. **请求体格式**（`FragmentResponse`）- 极高风险
4. **请求模式**（长轮询）- 中等风险
5. **缺少浏览器特征** - 中等风险

**推荐优先实施**：
1. 伪装URL路径（简单、高效）
2. 伪装HTTP头名称（简单、高效）
3. 添加浏览器特征（简单、中等效果）
4. 伪装请求体格式（中等复杂度、高效）

这些方案可以显著降低被防火墙识别的风险，同时保持协议的完整功能和性能。


