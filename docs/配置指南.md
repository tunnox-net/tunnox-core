# Tunnox 配置指南

本文档详细介绍 Tunnox Core 的配置方法和所有可用配置项。

---

## 目录

- [第1章：快速入门](#第1章快速入门)
- [第2章：配置层级](#第2章配置层级)
- [第3章：服务端配置](#第3章服务端配置)
- [第4章：客户端配置](#第4章客户端配置)
- [第5章：高级配置](#第5章高级配置)
- [第6章：配置参考](#第6章配置参考)

---

## 第1章：快速入门

### 1.1 零配置启动

Tunnox 支持开箱即用，无需任何配置文件即可启动。

**启动服务端：**

```bash
# 构建服务端
go build -o bin/server ./cmd/server

# 零配置启动
./bin/server
```

服务端将使用以下默认配置启动：
- TCP 协议监听 `0.0.0.0:8000`
- KCP 协议监听 `0.0.0.0:8000` (UDP)
- QUIC 协议监听 `0.0.0.0:8443`
- WebSocket 通过 HTTP 服务提供，监听 `0.0.0.0:9000`
- 管理 API 监听 `0.0.0.0:9000`
- 健康检查监听 `0.0.0.0:9090`

**启动客户端：**

```bash
# 构建客户端
go build -o bin/client ./cmd/client

# 匿名模式连接本地服务端
./bin/client -s 127.0.0.1:8000 -p tcp -anonymous
```

### 1.2 最小配置示例

如果需要自定义配置，创建一个 `config.yaml` 文件：

```yaml
# 最小化服务端配置
server:
  protocols:
    tcp:
      port: 8000

log:
  level: info
```

启动时指定配置文件：

```bash
./bin/server -config config.yaml
```

### 1.3 配置文件位置

Tunnox 按以下顺序搜索配置文件：

| 优先级 | 位置 | 说明 |
|--------|------|------|
| 1 | 命令行参数 `-config` | 最高优先级 |
| 2 | 当前目录 `./config.yaml` | 工作目录 |
| 3 | 用户目录 `~/.tunnox/config.yaml` | 用户级配置 |
| 4 | 系统目录 `/etc/tunnox/config.yaml` | 系统级配置 |

---

## 第2章：配置层级

### 2.1 配置优先级

Tunnox 支持多种配置来源，按以下优先级从高到低合并：

```
CLI 参数 > 环境变量 > .env 文件 > YAML 配置文件 > 默认值
```

这意味着：
- 命令行参数可以覆盖所有其他配置
- 环境变量可以覆盖配置文件中的值
- 配置文件可以覆盖默认值

### 2.2 环境变量命名规则

所有环境变量使用 `TUNNOX_` 前缀，配置路径用下划线分隔，全部大写。

**命名规则：**

```
YAML 路径: server.protocols.tcp.port
环境变量: TUNNOX_SERVER_TCP_PORT

YAML 路径: storage.redis.addr
环境变量: TUNNOX_REDIS_ADDR

YAML 路径: log.level
环境变量: TUNNOX_LOG_LEVEL
```

**示例：**

```bash
# 设置 TCP 端口
export TUNNOX_SERVER_TCP_PORT=9000

# 启用 Redis 存储
export TUNNOX_REDIS_ENABLED=true
export TUNNOX_REDIS_ADDR=redis:6379

# 设置日志级别
export TUNNOX_LOG_LEVEL=debug

# 启动服务端
./bin/server
```

### 2.3 .env 文件使用方法

创建 `.env` 文件在项目根目录或服务端工作目录：

```bash
# .env 文件示例

# 协议配置
TUNNOX_SERVER_TCP_PORT=8000
TUNNOX_SERVER_QUIC_PORT=8443

# Redis 配置
TUNNOX_REDIS_ENABLED=true
TUNNOX_REDIS_ADDR=localhost:6379
TUNNOX_REDIS_PASSWORD=your-password

# 日志配置
TUNNOX_LOG_LEVEL=info
TUNNOX_LOG_FILE=/var/log/tunnox/server.log

# 安全配置
TUNNOX_JWT_SECRET_KEY=your-32-character-secret-key

# HTTP 域名代理
TUNNOX_HTTP_BASE_DOMAINS=localhost.tunnox.dev,dev.example.com
```

> **注意**：`.env` 文件中的敏感信息不应提交到版本控制系统。

### 2.4 YAML 配置文件格式

完整的配置文件结构：

```yaml
# Tunnox 配置文件结构概览
server:           # 服务端核心配置
  protocols:      # 传输协议配置
  session:        # 会话管理配置

client:           # 客户端配置
  server:         # 连接服务器配置
  log:            # 日志配置
  stream:         # 流处理配置

management:       # 管理 API 配置
  auth:           # 认证配置
  pprof:          # 性能分析配置

http:             # HTTP 服务配置
  modules:        # 功能模块配置
  cors:           # 跨域配置
  rate_limit:     # 限流配置

storage:          # 存储配置
  redis:          # Redis 配置
  persistence:    # 本地持久化配置
  remote:         # 远程存储配置

security:         # 安全配置
  jwt:            # JWT 配置
  rate_limit:     # 速率限制配置

log:              # 日志配置
  rotation:       # 日志轮转配置

health:           # 健康检查配置

platform:         # 云控平台配置
```

---

## 第3章：服务端配置

### 3.1 协议配置

Tunnox 支持四种传输协议，各有不同的使用场景：

| 协议 | 默认端口 | 传输层 | 使用场景 |
|------|----------|--------|----------|
| TCP | 8000 | TCP | 稳定可靠，传统网络环境 |
| WebSocket | 9000 (HTTP) | TCP | 防火墙穿透，企业网络 |
| KCP | 8000 | UDP | 低延迟，实时应用，不稳定网络 |
| QUIC | 8443 | UDP | 多路复用，0-RTT 连接，移动网络 |

#### TCP 协议配置

```yaml
server:
  protocols:
    tcp:
      enabled: true          # 启用 TCP 协议
      port: 8000             # 监听端口
      host: "0.0.0.0"        # 监听地址
```

| 配置项 | 类型 | 默认值 | 环境变量 | 说明 |
|--------|------|--------|----------|------|
| `enabled` | bool | true | `TUNNOX_SERVER_TCP_ENABLED` | 启用 TCP 协议 |
| `port` | int | 8000 | `TUNNOX_SERVER_TCP_PORT` | TCP 监听端口 |
| `host` | string | "0.0.0.0" | `TUNNOX_SERVER_TCP_HOST` | TCP 监听地址 |

#### WebSocket 协议配置

WebSocket 协议通过 HTTP 服务提供，无独立端口。

```yaml
server:
  protocols:
    websocket:
      enabled: true          # 启用 WebSocket 协议
```

| 配置项 | 类型 | 默认值 | 环境变量 | 说明 |
|--------|------|--------|----------|------|
| `enabled` | bool | true | `TUNNOX_SERVER_WEBSOCKET_ENABLED` | 启用 WebSocket |

> **依赖关系**：WebSocket 协议依赖 HTTP 服务。如果启用 WebSocket，必须同时启用 `http.enabled=true` 和 `http.modules.websocket.enabled=true`。

#### KCP 协议配置

KCP 是基于 UDP 的可靠传输协议，适合高延迟、高丢包的网络环境。

```yaml
server:
  protocols:
    kcp:
      enabled: true          # 启用 KCP 协议
      port: 8000             # 监听端口 (UDP)
      host: "0.0.0.0"        # 监听地址
      mode: "fast"           # KCP 模式
      snd_wnd: 1024          # 发送窗口大小
      rcv_wnd: 1024          # 接收窗口大小
      mtu: 1400              # 最大传输单元
```

| 配置项 | 类型 | 默认值 | 环境变量 | 说明 |
|--------|------|--------|----------|------|
| `enabled` | bool | true | `TUNNOX_SERVER_KCP_ENABLED` | 启用 KCP 协议 |
| `port` | int | 8000 | `TUNNOX_SERVER_KCP_PORT` | KCP 监听端口 (UDP) |
| `host` | string | "0.0.0.0" | `TUNNOX_SERVER_KCP_HOST` | KCP 监听地址 |
| `mode` | string | "fast" | `TUNNOX_SERVER_KCP_MODE` | KCP 模式 |
| `snd_wnd` | int | 1024 | - | 发送窗口大小 |
| `rcv_wnd` | int | 1024 | - | 接收窗口大小 |
| `mtu` | int | 1400 | - | 最大传输单元 |

**KCP 模式说明：**

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| `normal` | 标准模式 | 一般场景 |
| `fast` | 快速模式（默认） | 低延迟场景 |
| `fast2` | 更快模式 | 实时应用 |
| `fast3` | 最快模式 | 极低延迟需求 |

#### QUIC 协议配置

QUIC 是基于 UDP 的新一代传输协议，支持多路复用和 0-RTT 连接。

```yaml
server:
  protocols:
    quic:
      enabled: true          # 启用 QUIC 协议
      port: 8443             # 监听端口
      host: "0.0.0.0"        # 监听地址
      max_streams: 100       # 最大并发流数
      idle_timeout: "30s"    # 空闲超时
```

| 配置项 | 类型 | 默认值 | 环境变量 | 说明 |
|--------|------|--------|----------|------|
| `enabled` | bool | true | `TUNNOX_SERVER_QUIC_ENABLED` | 启用 QUIC 协议 |
| `port` | int | 8443 | `TUNNOX_SERVER_QUIC_PORT` | QUIC 监听端口 |
| `host` | string | "0.0.0.0" | `TUNNOX_SERVER_QUIC_HOST` | QUIC 监听地址 |
| `max_streams` | int | 100 | - | 最大并发流数 |
| `idle_timeout` | duration | 30s | - | 空闲超时 |

### 3.2 会话管理配置

```yaml
server:
  session:
    heartbeat_timeout: "60s"        # 心跳超时
    cleanup_interval: "15s"         # 清理间隔
    max_connections: 10000          # 最大连接数
    max_control_connections: 5000   # 最大控制连接数
    reconnect_window: "300s"        # 重连窗口期
```

| 配置项 | 类型 | 默认值 | 环境变量 | 说明 |
|--------|------|--------|----------|------|
| `heartbeat_timeout` | duration | 60s | `TUNNOX_SESSION_HEARTBEAT_TIMEOUT` | 心跳超时时间 |
| `cleanup_interval` | duration | 15s | `TUNNOX_SESSION_CLEANUP_INTERVAL` | 会话清理间隔 |
| `max_connections` | int | 10000 | `TUNNOX_SESSION_MAX_CONNECTIONS` | 最大连接数 |
| `max_control_connections` | int | 5000 | `TUNNOX_SESSION_MAX_CONTROL_CONNECTIONS` | 最大控制连接数 |
| `reconnect_window` | duration | 300s | `TUNNOX_SESSION_RECONNECT_WINDOW` | 重连窗口期 |

### 3.3 HTTP 服务配置

HTTP 服务提供管理 API、WebSocket 协议接入和域名代理功能。

```yaml
http:
  enabled: true
  listen: "0.0.0.0:9000"

  modules:
    # 管理 API
    management_api:
      enabled: true
      prefix: "/_api"

    # WebSocket 协议接入
    websocket:
      enabled: true
      path: "/_tunnox"

    # 域名代理
    domain_proxy:
      enabled: false
      base_domains:
        - "localhost.tunnox.dev"
      default_subdomain_length: 8
      ssl:
        enabled: false
        cert_path: ""
        key_path: ""
        auto_ssl: false

    # WebSocket 代理
    websocket_proxy:
      enabled: false

  # CORS 配置
  cors:
    enabled: true
    allowed_origins:
      - "*"
    allowed_methods:
      - "GET"
      - "POST"
      - "PUT"
      - "DELETE"
      - "OPTIONS"
    allowed_headers:
      - "*"
    max_age: 86400

  # HTTP 限流
  rate_limit:
    enabled: false
    requests_per_second: 100
    burst: 200
```

#### HTTP 模块配置项

| 配置项 | 类型 | 默认值 | 环境变量 | 说明 |
|--------|------|--------|----------|------|
| `http.enabled` | bool | true | `TUNNOX_HTTP_ENABLED` | 启用 HTTP 服务 |
| `http.listen` | string | "0.0.0.0:9000" | `TUNNOX_HTTP_LISTEN` | HTTP 监听地址 |
| `http.modules.management_api.enabled` | bool | true | `TUNNOX_HTTP_MANAGEMENT_API_ENABLED` | 启用管理 API |
| `http.modules.management_api.prefix` | string | "/_api" | `TUNNOX_HTTP_MANAGEMENT_API_PREFIX` | API 路径前缀 |
| `http.modules.websocket.enabled` | bool | true | `TUNNOX_HTTP_WEBSOCKET_ENABLED` | 启用 WebSocket 模块 |
| `http.modules.websocket.path` | string | "/_tunnox" | `TUNNOX_HTTP_WEBSOCKET_PATH` | WebSocket 路径 |
| `http.modules.domain_proxy.enabled` | bool | false | `TUNNOX_HTTP_DOMAIN_PROXY_ENABLED` | 启用域名代理 |
| `http.modules.domain_proxy.base_domains` | []string | ["localhost.tunnox.dev"] | `TUNNOX_HTTP_BASE_DOMAINS` | 基础域名列表 |
| `http.modules.domain_proxy.default_subdomain_length` | int | 8 | `TUNNOX_HTTP_SUBDOMAIN_LENGTH` | 子域名长度 |

#### 域名代理配置

启用域名代理后，可以通过子域名访问隧道服务。

```yaml
http:
  modules:
    domain_proxy:
      enabled: true
      base_domains:
        - "tunnox.example.com"      # 生产域名
        - "dev.tunnox.local"        # 开发域名
      default_subdomain_length: 8
      ssl:
        enabled: true
        cert_path: "/etc/ssl/tunnox/cert.pem"
        key_path: "/etc/ssl/tunnox/key.pem"
```

> **注意**：启用域名代理时，必须配置 `base_domains`，否则功能无法正常工作。

### 3.4 存储配置

Tunnox 支持三种存储模式：

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| `memory` | 纯内存存储 | 单节点部署，快速启动 |
| `redis` | Redis 存储 | 多节点集群，数据共享 |
| `hybrid` | 混合存储 | 本地缓存 + 远程持久化 |

#### 内存存储模式（默认）

```yaml
storage:
  type: "memory"

  # 本地持久化（可选）
  persistence:
    enabled: true
    file: "data/tunnox.json"
    auto_save: true
    save_interval: "30s"
```

| 配置项 | 类型 | 默认值 | 环境变量 | 说明 |
|--------|------|--------|----------|------|
| `storage.type` | string | "memory" | `TUNNOX_STORAGE_TYPE` | 存储类型 |
| `storage.persistence.enabled` | bool | true | `TUNNOX_PERSISTENCE_ENABLED` | 启用持久化 |
| `storage.persistence.file` | string | "data/tunnox.json" | `TUNNOX_PERSISTENCE_FILE` | 持久化文件 |
| `storage.persistence.auto_save` | bool | true | `TUNNOX_PERSISTENCE_AUTO_SAVE` | 自动保存 |
| `storage.persistence.save_interval` | duration | 30s | `TUNNOX_PERSISTENCE_SAVE_INTERVAL` | 保存间隔 |

#### Redis 存储模式

```yaml
storage:
  type: "redis"

  redis:
    enabled: true
    addr: "localhost:6379"
    password: ""
    db: 0
    pool_size: 10
    min_idle_conns: 5
    max_retries: 3
    dial_timeout: "5s"
    read_timeout: "3s"
    write_timeout: "3s"
```

| 配置项 | 类型 | 默认值 | 环境变量 | 说明 |
|--------|------|--------|----------|------|
| `storage.redis.enabled` | bool | false | `TUNNOX_REDIS_ENABLED` | 启用 Redis |
| `storage.redis.addr` | string | "localhost:6379" | `TUNNOX_REDIS_ADDR` | Redis 地址 |
| `storage.redis.password` | secret | "" | `TUNNOX_REDIS_PASSWORD` | Redis 密码 |
| `storage.redis.db` | int | 0 | `TUNNOX_REDIS_DB` | Redis 数据库 |
| `storage.redis.pool_size` | int | 10 | `TUNNOX_REDIS_POOL_SIZE` | 连接池大小 |
| `storage.redis.min_idle_conns` | int | 5 | - | 最小空闲连接 |
| `storage.redis.max_retries` | int | 3 | - | 最大重试次数 |
| `storage.redis.dial_timeout` | duration | 5s | - | 连接超时 |
| `storage.redis.read_timeout` | duration | 3s | - | 读取超时 |
| `storage.redis.write_timeout` | duration | 3s | - | 写入超时 |

> **注意**：启用 Redis 存储模式后，本地持久化配置将被忽略。

#### 混合存储模式

混合存储模式结合本地缓存和远程存储，适合对性能和可靠性都有要求的场景。

```yaml
storage:
  type: "hybrid"

  remote:
    enabled: true
    grpc_address: "storage-service:50051"
    timeout: "5s"
    max_retries: 3
    tls:
      enabled: false
      cert_file: ""
      key_file: ""
      ca_file: ""

  hybrid:
    cache_type: "memory"              # memory/redis
    enable_persistent: false
    default_cache_ttl: "1h"
    persistent_cache_ttl: "24h"
    shared_cache_ttl: "5m"
```

| 配置项 | 类型 | 默认值 | 环境变量 | 说明 |
|--------|------|--------|----------|------|
| `storage.remote.enabled` | bool | false | `TUNNOX_STORAGE_REMOTE_ENABLED` | 启用远程存储 |
| `storage.remote.grpc_address` | string | "" | `TUNNOX_STORAGE_GRPC_ADDRESS` | gRPC 地址 |
| `storage.remote.timeout` | duration | 5s | `TUNNOX_STORAGE_TIMEOUT` | 超时时间 |
| `storage.remote.max_retries` | int | 3 | - | 最大重试次数 |
| `storage.hybrid.cache_type` | string | "memory" | - | 缓存类型 |
| `storage.hybrid.default_cache_ttl` | duration | 1h | - | 默认缓存 TTL |
| `storage.hybrid.persistent_cache_ttl` | duration | 24h | - | 持久化缓存 TTL |
| `storage.hybrid.shared_cache_ttl` | duration | 5m | - | 共享缓存 TTL |

### 3.5 管理 API 配置

管理 API 提供 RESTful 接口用于管理客户端和隧道。

```yaml
management:
  enabled: true
  listen: "0.0.0.0:9000"

  auth:
    type: "bearer"                    # none/bearer/basic
    token: ""                         # Bearer Token
    username: ""                      # Basic Auth 用户名
    password: ""                      # Basic Auth 密码

  pprof:
    enabled: true
    data_dir: "logs/pprof"

  cors:
    enabled: true
    allowed_origins:
      - "*"
```

| 配置项 | 类型 | 默认值 | 环境变量 | 说明 |
|--------|------|--------|----------|------|
| `management.enabled` | bool | true | `TUNNOX_MANAGEMENT_ENABLED` | 启用管理 API |
| `management.listen` | string | "0.0.0.0:9000" | `TUNNOX_MANAGEMENT_LISTEN` | 监听地址 |
| `management.auth.type` | string | "bearer" | `TUNNOX_MANAGEMENT_AUTH_TYPE` | 认证类型 |
| `management.auth.token` | secret | "" | `TUNNOX_MANAGEMENT_AUTH_TOKEN` | API Token |
| `management.auth.username` | string | "" | `TUNNOX_MANAGEMENT_AUTH_USERNAME` | Basic 用户名 |
| `management.auth.password` | secret | "" | `TUNNOX_MANAGEMENT_AUTH_PASSWORD` | Basic 密码 |
| `management.pprof.enabled` | bool | true | `TUNNOX_MANAGEMENT_PPROF_ENABLED` | 启用 PProf |
| `management.pprof.data_dir` | string | "logs/pprof" | `TUNNOX_MANAGEMENT_PPROF_DATA_DIR` | PProf 数据目录 |

**认证类型说明：**

| 类型 | 说明 | 配置要求 |
|------|------|----------|
| `none` | 无认证 | 仅限开发环境 |
| `bearer` | Bearer Token 认证 | 需配置 `token` |
| `basic` | HTTP Basic 认证 | 需配置 `username` 和 `password` |

> **安全建议**：生产环境务必配置认证，并使用强密码或 Token。

### 3.6 健康检查配置

健康检查服务用于 Kubernetes 探针和监控系统。

```yaml
health:
  enabled: true
  listen: "0.0.0.0:9090"

  endpoints:
    liveness: "/healthz"              # K8s liveness probe
    readiness: "/ready"               # K8s readiness probe
    startup: "/startup"               # K8s startup probe

  checks:
    storage:
      enabled: true
      timeout: "3s"
    redis:
      enabled: true
      timeout: "3s"
    protocols:
      enabled: true
      timeout: "3s"
```

| 配置项 | 类型 | 默认值 | 环境变量 | 说明 |
|--------|------|--------|----------|------|
| `health.enabled` | bool | true | `TUNNOX_HEALTH_ENABLED` | 启用健康检查 |
| `health.listen` | string | "0.0.0.0:9090" | `TUNNOX_HEALTH_LISTEN` | 监听地址 |
| `health.endpoints.liveness` | string | "/healthz" | `TUNNOX_HEALTH_LIVENESS_PATH` | Liveness 端点 |
| `health.endpoints.readiness` | string | "/ready" | `TUNNOX_HEALTH_READINESS_PATH` | Readiness 端点 |
| `health.endpoints.startup` | string | "/startup" | `TUNNOX_HEALTH_STARTUP_PATH` | Startup 端点 |
| `health.checks.storage.enabled` | bool | true | `TUNNOX_HEALTH_CHECK_STORAGE` | 检查存储 |
| `health.checks.redis.enabled` | bool | true | `TUNNOX_HEALTH_CHECK_REDIS` | 检查 Redis |
| `health.checks.protocols.enabled` | bool | true | `TUNNOX_HEALTH_CHECK_PROTOCOLS` | 检查协议 |

### 3.7 安全配置

#### JWT 配置

```yaml
security:
  jwt:
    secret_key: ""                    # JWT 签名密钥 (生产环境必填)
    expiration: "24h"                 # Token 过期时间
    refresh_expiration: "168h"        # Refresh Token 过期时间 (7天)
    issuer: "tunnox"
```

| 配置项 | 类型 | 默认值 | 环境变量 | 说明 |
|--------|------|--------|----------|------|
| `security.jwt.secret_key` | secret | "" | `TUNNOX_JWT_SECRET_KEY` | JWT 签名密钥 |
| `security.jwt.expiration` | duration | 24h | `TUNNOX_JWT_EXPIRATION` | Token 过期时间 |
| `security.jwt.refresh_expiration` | duration | 168h | `TUNNOX_JWT_REFRESH_EXPIRATION` | Refresh Token 过期 |
| `security.jwt.issuer` | string | "tunnox" | `TUNNOX_JWT_ISSUER` | JWT 签发者 |

> **安全建议**：生产环境必须配置 `secret_key`，长度至少 32 字符。

#### 速率限制配置

```yaml
security:
  rate_limit:
    # IP 级别限流
    ip:
      enabled: true
      rate: 10                        # 每秒请求数
      burst: 20                       # 突发容量
      ttl: "5m"                       # Bucket TTL

    # 隧道级别限流
    tunnel:
      enabled: false
      rate: 1048576                   # 字节/秒 (1MB/s)
      burst: 10485760                 # 突发容量 (10MB)

    # 客户端级别限流
    client:
      enabled: false
      rate: 100                       # 请求/秒
      burst: 200
```

| 配置项 | 类型 | 默认值 | 环境变量 | 说明 |
|--------|------|--------|----------|------|
| `security.rate_limit.ip.enabled` | bool | true | `TUNNOX_RATE_LIMIT_IP_ENABLED` | 启用 IP 限流 |
| `security.rate_limit.ip.rate` | int | 10 | `TUNNOX_RATE_LIMIT_IP_RATE` | IP 请求速率 |
| `security.rate_limit.ip.burst` | int | 20 | `TUNNOX_RATE_LIMIT_IP_BURST` | IP 突发容量 |
| `security.rate_limit.tunnel.enabled` | bool | false | `TUNNOX_RATE_LIMIT_TUNNEL_ENABLED` | 启用隧道限流 |
| `security.rate_limit.tunnel.rate` | int64 | 1048576 | `TUNNOX_RATE_LIMIT_TUNNEL_RATE` | 隧道流量速率 |

#### 访问控制配置

```yaml
security:
  access_control:
    enabled: false
    whitelist:
      ips:
        - "192.168.1.100"
      cidrs:
        - "10.0.0.0/8"
    blacklist:
      ips: []
      cidrs: []
```

### 3.8 日志配置

```yaml
log:
  level: "info"                       # debug/info/warn/error
  format: "text"                      # text/json
  file: "logs/server.log"             # 日志文件路径
  console: true                       # 同时输出到控制台

  rotation:
    enabled: true
    max_size: 100                     # 单文件最大 MB
    max_backups: 10                   # 保留文件数
    max_age: 30                       # 保留天数
    compress: false                   # 压缩旧日志
```

| 配置项 | 类型 | 默认值 | 环境变量 | 说明 |
|--------|------|--------|----------|------|
| `log.level` | string | "info" | `TUNNOX_LOG_LEVEL` | 日志级别 |
| `log.format` | string | "text" | `TUNNOX_LOG_FORMAT` | 日志格式 |
| `log.file` | string | "logs/server.log" | `TUNNOX_LOG_FILE` | 日志文件 |
| `log.console` | bool | true | `TUNNOX_LOG_CONSOLE` | 控制台输出 |
| `log.rotation.enabled` | bool | true | `TUNNOX_LOG_ROTATION_ENABLED` | 启用轮转 |
| `log.rotation.max_size` | int | 100 | `TUNNOX_LOG_ROTATION_MAX_SIZE` | 单文件最大 MB |
| `log.rotation.max_backups` | int | 10 | `TUNNOX_LOG_ROTATION_MAX_BACKUPS` | 保留文件数 |
| `log.rotation.max_age` | int | 30 | `TUNNOX_LOG_ROTATION_MAX_AGE` | 保留天数 |
| `log.rotation.compress` | bool | false | `TUNNOX_LOG_ROTATION_COMPRESS` | 压缩旧日志 |

**日志级别说明：**

| 级别 | 说明 |
|------|------|
| `debug` | 调试信息，最详细 |
| `info` | 一般信息（默认） |
| `warn` | 警告信息 |
| `error` | 错误信息 |

---

## 第4章：客户端配置

### 4.1 连接配置

```yaml
client:
  # 服务器连接
  server:
    address: "https://gw.tunnox.net/_tunnox"   # 服务器地址
    protocol: "websocket"                       # 协议类型
    auto_reconnect: true                        # 自动重连
    reconnect_interval: "5s"                    # 重连间隔
    connect_timeout: "30s"                      # 连接超时
```

| 配置项 | 类型 | 默认值 | CLI 参数 | 环境变量 | 说明 |
|--------|------|--------|----------|----------|------|
| `client.server.address` | string | "https://gw.tunnox.net/_tunnox" | `-s` | `TUNNOX_SERVER_ADDRESS` | 服务器地址 |
| `client.server.protocol` | string | "websocket" | `-p` | `TUNNOX_SERVER_PROTOCOL` | 协议类型 |
| `client.server.auto_reconnect` | bool | true | - | `TUNNOX_SERVER_AUTO_RECONNECT` | 自动重连 |
| `client.server.reconnect_interval` | duration | 5s | - | `TUNNOX_SERVER_RECONNECT_INTERVAL` | 重连间隔 |
| `client.server.connect_timeout` | duration | 30s | - | `TUNNOX_SERVER_CONNECT_TIMEOUT` | 连接超时 |

### 4.2 认证配置

Tunnox 客户端支持两种认证模式：

#### 匿名模式

```yaml
client:
  anonymous: true                     # 启用匿名模式
  device_id: "auto"                   # 设备 ID ("auto" 自动生成)
  secret_key: ""                      # 匿名密钥（可选）
```

使用命令行参数：

```bash
./bin/client -s 127.0.0.1:8000 -p tcp -anonymous
```

#### 注册模式

```yaml
client:
  anonymous: false                    # 禁用匿名模式
  client_id: 12345                    # 客户端 ID
  auth_token: "your-auth-token"       # 认证 Token
```

使用命令行参数：

```bash
./bin/client -s 127.0.0.1:8000 -p tcp -id 12345 -token "your-auth-token"
```

| 配置项 | 类型 | 默认值 | CLI 参数 | 环境变量 | 说明 |
|--------|------|--------|----------|----------|------|
| `client.anonymous` | bool | true | `-anonymous` | `TUNNOX_CLIENT_ANONYMOUS` | 匿名模式 |
| `client.device_id` | string | "auto" | `-device` | `TUNNOX_CLIENT_DEVICE_ID` | 设备 ID |
| `client.secret_key` | secret | "" | - | `TUNNOX_CLIENT_SECRET_KEY` | 匿名密钥 |
| `client.client_id` | int64 | 0 | `-id` | `TUNNOX_CLIENT_ID` | 客户端 ID |
| `client.auth_token` | secret | "" | `-token` | `TUNNOX_CLIENT_TOKEN` | 认证 Token |

### 4.3 协议选择

客户端可以指定连接协议：

```yaml
client:
  server:
    protocol: "websocket"             # tcp/websocket/kcp/quic/auto
```

| 协议 | 说明 | 典型服务器地址 |
|------|------|----------------|
| `tcp` | 直接 TCP 连接 | `127.0.0.1:8000` |
| `websocket` | WebSocket 连接 | `https://server:9000/_tunnox` |
| `kcp` | KCP (UDP) 连接 | `127.0.0.1:8000` |
| `quic` | QUIC (UDP) 连接 | `127.0.0.1:8443` |
| `auto` | 自动选择最佳协议 | 自动检测 |

### 4.4 流处理配置

```yaml
client:
  stream:
    enable_compression: false         # 启用压缩
    compression_level: 6              # 压缩级别 (1-9)
    buffer_size: 4096                 # 缓冲区大小
```

| 配置项 | 类型 | 默认值 | 环境变量 | 说明 |
|--------|------|--------|----------|------|
| `client.stream.enable_compression` | bool | false | - | 启用压缩 |
| `client.stream.compression_level` | int | 6 | - | 压缩级别 (1-9) |
| `client.stream.buffer_size` | int | 4096 | - | 缓冲区大小 |

**压缩级别说明：**

| 级别 | 说明 |
|------|------|
| 1 | 最快速度，最低压缩率 |
| 6 | 平衡模式（默认） |
| 9 | 最高压缩率，最慢速度 |

### 4.5 客户端日志配置

```yaml
client:
  log:
    level: "info"                     # debug/info/warn/error
    format: "text"                    # text/json
    file: ""                          # 空则自动检测
```

| 配置项 | 类型 | 默认值 | CLI 参数 | 环境变量 | 说明 |
|--------|------|--------|----------|----------|------|
| `client.log.level` | string | "info" | - | `TUNNOX_LOG_LEVEL` | 日志级别 |
| `client.log.format` | string | "text" | - | `TUNNOX_LOG_FORMAT` | 日志格式 |
| `client.log.file` | string | "" | `-log` | `TUNNOX_LOG_FILE` | 日志文件 |

---

## 第5章：高级配置

### 5.1 集群部署

#### Redis 集群模式

多节点部署时使用 Redis 作为共享存储：

```yaml
# server-cluster.yaml
storage:
  type: "redis"
  redis:
    enabled: true
    addr: "redis-cluster:6379"
    password: "${REDIS_PASSWORD}"
    pool_size: 20

# 节点 ID 自动分配（node-0001 到 node-1000）
```

#### Docker Compose 集群部署

```yaml
# docker-compose-cluster.yaml
version: '3.8'

services:
  redis:
    image: redis:7-alpine
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data
    networks:
      - tunnox-net

  tunnox-server-1:
    image: tunnox/server:latest
    environment:
      - TUNNOX_STORAGE_TYPE=redis
      - TUNNOX_REDIS_ENABLED=true
      - TUNNOX_REDIS_ADDR=redis:6379
      - TUNNOX_REDIS_PASSWORD=${REDIS_PASSWORD}
      - TUNNOX_SERVER_TCP_PORT=8000
    ports:
      - "8000:8000"
      - "9000:9000"
    depends_on:
      - redis
    networks:
      - tunnox-net

  tunnox-server-2:
    image: tunnox/server:latest
    environment:
      - TUNNOX_STORAGE_TYPE=redis
      - TUNNOX_REDIS_ENABLED=true
      - TUNNOX_REDIS_ADDR=redis:6379
      - TUNNOX_REDIS_PASSWORD=${REDIS_PASSWORD}
      - TUNNOX_SERVER_TCP_PORT=8000
    ports:
      - "8001:8000"
      - "9001:9000"
    depends_on:
      - redis
    networks:
      - tunnox-net

volumes:
  redis-data:

networks:
  tunnox-net:
```

#### Kubernetes 部署

```yaml
# k8s-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: tunnox-server
spec:
  replicas: 3
  selector:
    matchLabels:
      app: tunnox-server
  template:
    metadata:
      labels:
        app: tunnox-server
    spec:
      containers:
      - name: tunnox-server
        image: tunnox/server:latest
        ports:
        - containerPort: 8000
          name: tcp
        - containerPort: 9000
          name: http
        - containerPort: 9090
          name: health
        env:
        - name: TUNNOX_STORAGE_TYPE
          value: "redis"
        - name: TUNNOX_REDIS_ENABLED
          value: "true"
        - name: TUNNOX_REDIS_ADDR
          value: "redis-service:6379"
        - name: TUNNOX_REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: tunnox-secrets
              key: redis-password
        livenessProbe:
          httpGet:
            path: /healthz
            port: 9090
          initialDelaySeconds: 10
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /ready
            port: 9090
          initialDelaySeconds: 5
          periodSeconds: 5
        startupProbe:
          httpGet:
            path: /startup
            port: 9090
          failureThreshold: 30
          periodSeconds: 10
```

### 5.2 性能调优

#### 高并发场景

```yaml
server:
  session:
    max_connections: 50000
    max_control_connections: 25000
    cleanup_interval: "30s"

storage:
  redis:
    pool_size: 50
    min_idle_conns: 20

security:
  rate_limit:
    ip:
      rate: 100
      burst: 500
    client:
      enabled: true
      rate: 1000
      burst: 2000
```

#### 低延迟场景

```yaml
server:
  protocols:
    kcp:
      enabled: true
      mode: "fast3"                   # 最快模式
      snd_wnd: 2048
      rcv_wnd: 2048

  session:
    heartbeat_timeout: "30s"          # 更短的心跳超时
    cleanup_interval: "10s"
```

#### 高吞吐量场景

```yaml
server:
  protocols:
    tcp:
      enabled: true
    quic:
      enabled: true
      max_streams: 500                # 更多并发流

client:
  stream:
    enable_compression: true
    compression_level: 1              # 快速压缩
    buffer_size: 65536                # 更大缓冲区
```

### 5.3 安全加固

#### 生产环境安全配置

```yaml
# 安全加固配置
security:
  jwt:
    secret_key: "${JWT_SECRET_KEY}"   # 使用环境变量
    expiration: "2h"                  # 缩短 Token 有效期
    refresh_expiration: "24h"

  rate_limit:
    ip:
      enabled: true
      rate: 50
      burst: 100

  access_control:
    enabled: true
    whitelist:
      cidrs:
        - "10.0.0.0/8"                # 内网 IP
        - "172.16.0.0/12"
        - "192.168.0.0/16"

management:
  auth:
    type: "bearer"
    token: "${MANAGEMENT_API_TOKEN}"

http:
  modules:
    domain_proxy:
      ssl:
        enabled: true
        cert_path: "/etc/ssl/tunnox/cert.pem"
        key_path: "/etc/ssl/tunnox/key.pem"

log:
  level: "info"                       # 不使用 debug 级别
  format: "json"                      # 结构化日志便于分析
```

#### TLS 证书配置

```yaml
http:
  modules:
    domain_proxy:
      ssl:
        enabled: true
        cert_path: "/etc/ssl/tunnox/fullchain.pem"
        key_path: "/etc/ssl/tunnox/privkey.pem"
        auto_ssl: false               # 手动管理证书

storage:
  remote:
    tls:
      enabled: true
      cert_file: "/etc/ssl/client-cert.pem"
      key_file: "/etc/ssl/client-key.pem"
      ca_file: "/etc/ssl/ca.pem"
```

### 5.4 监控集成

#### Prometheus 指标

Tunnox 通过管理 API 暴露 Prometheus 格式的指标：

```bash
# 获取指标
curl http://localhost:9000/_api/metrics
```

#### Systemd 服务配置

```ini
# /etc/systemd/system/tunnox-server.service
[Unit]
Description=Tunnox Server
After=network.target redis.service

[Service]
Type=simple
User=tunnox
Group=tunnox
WorkingDirectory=/opt/tunnox
ExecStart=/opt/tunnox/bin/server -config /etc/tunnox/config.yaml
Restart=always
RestartSec=5
LimitNOFILE=65535

# 环境变量文件
EnvironmentFile=-/etc/tunnox/tunnox.env

[Install]
WantedBy=multi-user.target
```

### 5.5 云控平台配置

连接 Tunnox Platform 进行集中管理：

```yaml
platform:
  enabled: true
  url: "https://platform.tunnox.net"
  token: "${PLATFORM_TOKEN}"
  timeout: "10s"
  retry:
    max_retries: 3
    retry_interval: "1s"
```

| 配置项 | 类型 | 默认值 | 环境变量 | 说明 |
|--------|------|--------|----------|------|
| `platform.enabled` | bool | false | `TUNNOX_PLATFORM_ENABLED` | 启用云控平台 |
| `platform.url` | string | "" | `TUNNOX_PLATFORM_URL` | 平台 API 地址 |
| `platform.token` | secret | "" | `TUNNOX_PLATFORM_TOKEN` | API Token |
| `platform.timeout` | duration | 10s | `TUNNOX_PLATFORM_TIMEOUT` | 请求超时 |

---

## 第6章：配置参考

### 6.1 完整服务端配置模板

```yaml
# Tunnox Server 完整配置模板
# 版本: 1.0

# =============================================================================
# 服务端配置
# =============================================================================
server:
  # 协议配置
  protocols:
    tcp:
      enabled: true                   # 启用 TCP 协议
      port: 8000                      # TCP 监听端口
      host: "0.0.0.0"                 # TCP 监听地址

    websocket:
      enabled: true                   # 启用 WebSocket (依赖 HTTP 服务)

    kcp:
      enabled: true                   # 启用 KCP 协议
      port: 8000                      # KCP 监听端口 (UDP)
      host: "0.0.0.0"
      mode: "fast"                    # normal/fast/fast2/fast3
      snd_wnd: 1024
      rcv_wnd: 1024
      mtu: 1400

    quic:
      enabled: true                   # 启用 QUIC 协议
      port: 8443
      host: "0.0.0.0"
      max_streams: 100
      idle_timeout: "30s"

  # 会话配置
  session:
    heartbeat_timeout: "60s"
    cleanup_interval: "15s"
    max_connections: 10000
    max_control_connections: 5000
    reconnect_window: "300s"

# =============================================================================
# HTTP 服务配置
# =============================================================================
http:
  enabled: true
  listen: "0.0.0.0:9000"

  modules:
    management_api:
      enabled: true
      prefix: "/_api"

    websocket:
      enabled: true
      path: "/_tunnox"

    domain_proxy:
      enabled: false
      base_domains:
        - "localhost.tunnox.dev"
      default_subdomain_length: 8
      ssl:
        enabled: false
        cert_path: ""
        key_path: ""
        auto_ssl: false

    websocket_proxy:
      enabled: false

  cors:
    enabled: true
    allowed_origins: ["*"]
    allowed_methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
    allowed_headers: ["*"]
    max_age: 86400

  rate_limit:
    enabled: false
    requests_per_second: 100
    burst: 200

# =============================================================================
# 管理 API 配置
# =============================================================================
management:
  enabled: true
  listen: "0.0.0.0:9000"

  auth:
    type: "bearer"                    # none/bearer/basic
    token: ""
    username: ""
    password: ""

  pprof:
    enabled: true
    data_dir: "logs/pprof"

  cors:
    enabled: true
    allowed_origins: ["*"]

# =============================================================================
# 存储配置
# =============================================================================
storage:
  type: "memory"                      # memory/redis/hybrid

  redis:
    enabled: false
    addr: "localhost:6379"
    password: ""
    db: 0
    pool_size: 10
    min_idle_conns: 5
    max_retries: 3
    dial_timeout: "5s"
    read_timeout: "3s"
    write_timeout: "3s"

  persistence:
    enabled: true
    file: "data/tunnox.json"
    auto_save: true
    save_interval: "30s"

  remote:
    enabled: false
    grpc_address: ""
    timeout: "5s"
    max_retries: 3
    tls:
      enabled: false
      cert_file: ""
      key_file: ""
      ca_file: ""

  hybrid:
    cache_type: "memory"
    enable_persistent: false
    default_cache_ttl: "1h"
    persistent_cache_ttl: "24h"
    shared_cache_ttl: "5m"

# =============================================================================
# 安全配置
# =============================================================================
security:
  jwt:
    secret_key: ""
    expiration: "24h"
    refresh_expiration: "168h"
    issuer: "tunnox"

  rate_limit:
    ip:
      enabled: true
      rate: 10
      burst: 20
      ttl: "5m"

    tunnel:
      enabled: false
      rate: 1048576
      burst: 10485760

    client:
      enabled: false
      rate: 100
      burst: 200

  access_control:
    enabled: false
    whitelist:
      ips: []
      cidrs: []
    blacklist:
      ips: []
      cidrs: []

# =============================================================================
# 日志配置
# =============================================================================
log:
  level: "info"                       # debug/info/warn/error
  format: "text"                      # text/json
  file: "logs/server.log"
  console: true

  rotation:
    enabled: true
    max_size: 100                     # MB
    max_backups: 10
    max_age: 30                       # days
    compress: false

# =============================================================================
# 健康检查配置
# =============================================================================
health:
  enabled: true
  listen: "0.0.0.0:9090"

  endpoints:
    liveness: "/healthz"
    readiness: "/ready"
    startup: "/startup"

  checks:
    storage:
      enabled: true
      timeout: "3s"
    redis:
      enabled: true
      timeout: "3s"
    protocols:
      enabled: true
      timeout: "3s"

# =============================================================================
# 云控平台配置
# =============================================================================
platform:
  enabled: false
  url: ""
  token: ""
  timeout: "10s"
  retry:
    max_retries: 3
    retry_interval: "1s"
```

### 6.2 完整客户端配置模板

```yaml
# Tunnox Client 完整配置模板
# 版本: 1.0

# =============================================================================
# 认证配置
# =============================================================================
client:
  # 匿名模式
  anonymous: true
  device_id: "auto"
  secret_key: ""

  # 注册模式 (anonymous: false 时使用)
  client_id: 0
  auth_token: ""

  # =============================================================================
  # 服务器连接配置
  # =============================================================================
  server:
    address: "https://gw.tunnox.net/_tunnox"
    protocol: "websocket"             # tcp/websocket/kcp/quic/auto
    auto_reconnect: true
    reconnect_interval: "5s"
    connect_timeout: "30s"

  # =============================================================================
  # 日志配置
  # =============================================================================
  log:
    level: "info"                     # debug/info/warn/error
    format: "text"                    # text/json
    file: ""

  # =============================================================================
  # 流处理配置
  # =============================================================================
  stream:
    enable_compression: false
    compression_level: 6              # 1-9
    buffer_size: 4096
```

### 6.3 环境变量完整对照表

#### 服务端环境变量

| 环境变量 | 配置路径 | 类型 | 默认值 |
|----------|----------|------|--------|
| `TUNNOX_SERVER_TCP_ENABLED` | server.protocols.tcp.enabled | bool | true |
| `TUNNOX_SERVER_TCP_PORT` | server.protocols.tcp.port | int | 8000 |
| `TUNNOX_SERVER_TCP_HOST` | server.protocols.tcp.host | string | "0.0.0.0" |
| `TUNNOX_SERVER_WEBSOCKET_ENABLED` | server.protocols.websocket.enabled | bool | true |
| `TUNNOX_SERVER_KCP_ENABLED` | server.protocols.kcp.enabled | bool | true |
| `TUNNOX_SERVER_KCP_PORT` | server.protocols.kcp.port | int | 8000 |
| `TUNNOX_SERVER_KCP_HOST` | server.protocols.kcp.host | string | "0.0.0.0" |
| `TUNNOX_SERVER_KCP_MODE` | server.protocols.kcp.mode | string | "fast" |
| `TUNNOX_SERVER_QUIC_ENABLED` | server.protocols.quic.enabled | bool | true |
| `TUNNOX_SERVER_QUIC_PORT` | server.protocols.quic.port | int | 8443 |
| `TUNNOX_SERVER_QUIC_HOST` | server.protocols.quic.host | string | "0.0.0.0" |
| `TUNNOX_SESSION_HEARTBEAT_TIMEOUT` | server.session.heartbeat_timeout | duration | 60s |
| `TUNNOX_SESSION_CLEANUP_INTERVAL` | server.session.cleanup_interval | duration | 15s |
| `TUNNOX_SESSION_MAX_CONNECTIONS` | server.session.max_connections | int | 10000 |
| `TUNNOX_SESSION_MAX_CONTROL_CONNECTIONS` | server.session.max_control_connections | int | 5000 |
| `TUNNOX_SESSION_RECONNECT_WINDOW` | server.session.reconnect_window | duration | 300s |
| `TUNNOX_HTTP_ENABLED` | http.enabled | bool | true |
| `TUNNOX_HTTP_LISTEN` | http.listen | string | "0.0.0.0:9000" |
| `TUNNOX_HTTP_MANAGEMENT_API_ENABLED` | http.modules.management_api.enabled | bool | true |
| `TUNNOX_HTTP_MANAGEMENT_API_PREFIX` | http.modules.management_api.prefix | string | "/_api" |
| `TUNNOX_HTTP_WEBSOCKET_ENABLED` | http.modules.websocket.enabled | bool | true |
| `TUNNOX_HTTP_WEBSOCKET_PATH` | http.modules.websocket.path | string | "/_tunnox" |
| `TUNNOX_HTTP_DOMAIN_PROXY_ENABLED` | http.modules.domain_proxy.enabled | bool | false |
| `TUNNOX_HTTP_BASE_DOMAINS` | http.modules.domain_proxy.base_domains | []string | ["localhost.tunnox.dev"] |
| `TUNNOX_HTTP_SUBDOMAIN_LENGTH` | http.modules.domain_proxy.default_subdomain_length | int | 8 |
| `TUNNOX_HTTP_SSL_ENABLED` | http.modules.domain_proxy.ssl.enabled | bool | false |
| `TUNNOX_HTTP_SSL_CERT_PATH` | http.modules.domain_proxy.ssl.cert_path | string | "" |
| `TUNNOX_HTTP_SSL_KEY_PATH` | http.modules.domain_proxy.ssl.key_path | string | "" |
| `TUNNOX_HTTP_CORS_ENABLED` | http.cors.enabled | bool | true |
| `TUNNOX_HTTP_CORS_ORIGINS` | http.cors.allowed_origins | []string | ["*"] |
| `TUNNOX_HTTP_RATE_LIMIT_ENABLED` | http.rate_limit.enabled | bool | false |
| `TUNNOX_HTTP_RATE_LIMIT_RPS` | http.rate_limit.requests_per_second | int | 100 |
| `TUNNOX_MANAGEMENT_ENABLED` | management.enabled | bool | true |
| `TUNNOX_MANAGEMENT_LISTEN` | management.listen | string | "0.0.0.0:9000" |
| `TUNNOX_MANAGEMENT_AUTH_TYPE` | management.auth.type | string | "bearer" |
| `TUNNOX_MANAGEMENT_AUTH_TOKEN` | management.auth.token | secret | "" |
| `TUNNOX_MANAGEMENT_AUTH_USERNAME` | management.auth.username | string | "" |
| `TUNNOX_MANAGEMENT_AUTH_PASSWORD` | management.auth.password | secret | "" |
| `TUNNOX_MANAGEMENT_PPROF_ENABLED` | management.pprof.enabled | bool | true |
| `TUNNOX_MANAGEMENT_PPROF_DATA_DIR` | management.pprof.data_dir | string | "logs/pprof" |
| `TUNNOX_STORAGE_TYPE` | storage.type | string | "memory" |
| `TUNNOX_REDIS_ENABLED` | storage.redis.enabled | bool | false |
| `TUNNOX_REDIS_ADDR` | storage.redis.addr | string | "localhost:6379" |
| `TUNNOX_REDIS_PASSWORD` | storage.redis.password | secret | "" |
| `TUNNOX_REDIS_DB` | storage.redis.db | int | 0 |
| `TUNNOX_REDIS_POOL_SIZE` | storage.redis.pool_size | int | 10 |
| `TUNNOX_PERSISTENCE_ENABLED` | storage.persistence.enabled | bool | true |
| `TUNNOX_PERSISTENCE_FILE` | storage.persistence.file | string | "data/tunnox.json" |
| `TUNNOX_PERSISTENCE_AUTO_SAVE` | storage.persistence.auto_save | bool | true |
| `TUNNOX_PERSISTENCE_SAVE_INTERVAL` | storage.persistence.save_interval | duration | 30s |
| `TUNNOX_STORAGE_REMOTE_ENABLED` | storage.remote.enabled | bool | false |
| `TUNNOX_STORAGE_GRPC_ADDRESS` | storage.remote.grpc_address | string | "" |
| `TUNNOX_STORAGE_TIMEOUT` | storage.remote.timeout | duration | 5s |
| `TUNNOX_JWT_SECRET_KEY` | security.jwt.secret_key | secret | "" |
| `TUNNOX_JWT_EXPIRATION` | security.jwt.expiration | duration | 24h |
| `TUNNOX_JWT_REFRESH_EXPIRATION` | security.jwt.refresh_expiration | duration | 168h |
| `TUNNOX_JWT_ISSUER` | security.jwt.issuer | string | "tunnox" |
| `TUNNOX_RATE_LIMIT_IP_ENABLED` | security.rate_limit.ip.enabled | bool | true |
| `TUNNOX_RATE_LIMIT_IP_RATE` | security.rate_limit.ip.rate | int | 10 |
| `TUNNOX_RATE_LIMIT_IP_BURST` | security.rate_limit.ip.burst | int | 20 |
| `TUNNOX_RATE_LIMIT_TUNNEL_ENABLED` | security.rate_limit.tunnel.enabled | bool | false |
| `TUNNOX_RATE_LIMIT_TUNNEL_RATE` | security.rate_limit.tunnel.rate | int64 | 1048576 |
| `TUNNOX_LOG_LEVEL` | log.level | string | "info" |
| `TUNNOX_LOG_FORMAT` | log.format | string | "text" |
| `TUNNOX_LOG_FILE` | log.file | string | "logs/server.log" |
| `TUNNOX_LOG_CONSOLE` | log.console | bool | true |
| `TUNNOX_LOG_ROTATION_ENABLED` | log.rotation.enabled | bool | true |
| `TUNNOX_LOG_ROTATION_MAX_SIZE` | log.rotation.max_size | int | 100 |
| `TUNNOX_LOG_ROTATION_MAX_BACKUPS` | log.rotation.max_backups | int | 10 |
| `TUNNOX_LOG_ROTATION_MAX_AGE` | log.rotation.max_age | int | 30 |
| `TUNNOX_LOG_ROTATION_COMPRESS` | log.rotation.compress | bool | false |
| `TUNNOX_HEALTH_ENABLED` | health.enabled | bool | true |
| `TUNNOX_HEALTH_LISTEN` | health.listen | string | "0.0.0.0:9090" |
| `TUNNOX_HEALTH_LIVENESS_PATH` | health.endpoints.liveness | string | "/healthz" |
| `TUNNOX_HEALTH_READINESS_PATH` | health.endpoints.readiness | string | "/ready" |
| `TUNNOX_HEALTH_STARTUP_PATH` | health.endpoints.startup | string | "/startup" |
| `TUNNOX_HEALTH_CHECK_STORAGE` | health.checks.storage.enabled | bool | true |
| `TUNNOX_HEALTH_CHECK_REDIS` | health.checks.redis.enabled | bool | true |
| `TUNNOX_HEALTH_CHECK_PROTOCOLS` | health.checks.protocols.enabled | bool | true |
| `TUNNOX_PLATFORM_ENABLED` | platform.enabled | bool | false |
| `TUNNOX_PLATFORM_URL` | platform.url | string | "" |
| `TUNNOX_PLATFORM_TOKEN` | platform.token | secret | "" |
| `TUNNOX_PLATFORM_TIMEOUT` | platform.timeout | duration | 10s |

#### 客户端环境变量

| 环境变量 | 配置路径 | 类型 | 默认值 |
|----------|----------|------|--------|
| `TUNNOX_CLIENT_ID` | client.client_id | int64 | 0 |
| `TUNNOX_CLIENT_TOKEN` | client.auth_token | secret | "" |
| `TUNNOX_CLIENT_ANONYMOUS` | client.anonymous | bool | true |
| `TUNNOX_CLIENT_DEVICE_ID` | client.device_id | string | "auto" |
| `TUNNOX_CLIENT_SECRET_KEY` | client.secret_key | secret | "" |
| `TUNNOX_SERVER_ADDRESS` | client.server.address | string | "https://gw.tunnox.net/_tunnox" |
| `TUNNOX_SERVER_PROTOCOL` | client.server.protocol | string | "websocket" |
| `TUNNOX_SERVER_AUTO_RECONNECT` | client.server.auto_reconnect | bool | true |
| `TUNNOX_SERVER_RECONNECT_INTERVAL` | client.server.reconnect_interval | duration | 5s |
| `TUNNOX_SERVER_CONNECT_TIMEOUT` | client.server.connect_timeout | duration | 30s |
| `TUNNOX_LOG_LEVEL` | client.log.level | string | "info" |
| `TUNNOX_LOG_FORMAT` | client.log.format | string | "text" |
| `TUNNOX_LOG_FILE` | client.log.file | string | "" |

### 6.4 协议端口速查表

| 协议 | 默认端口 | 传输层 | 环境变量 |
|------|----------|--------|----------|
| TCP | 8000 | TCP | `TUNNOX_SERVER_TCP_PORT` |
| WebSocket | 9000 (HTTP) | TCP | `TUNNOX_HTTP_LISTEN` |
| KCP | 8000 | UDP | `TUNNOX_SERVER_KCP_PORT` |
| QUIC | 8443 | UDP | `TUNNOX_SERVER_QUIC_PORT` |
| 管理 API | 9000 | TCP | `TUNNOX_MANAGEMENT_LISTEN` |
| 健康检查 | 9090 | TCP | `TUNNOX_HEALTH_LISTEN` |

---

## 附录

### A. 常见问题

#### Q: 配置文件修改后需要重启吗？

A: 是的，当前版本不支持配置热重载，修改配置后需要重启服务。

#### Q: WebSocket 协议为什么没有独立端口？

A: WebSocket 协议通过 HTTP 服务提供，使用 HTTP 服务的端口（默认 9000），路径为 `/_tunnox`。

#### Q: 如何验证配置是否正确？

A: 启动服务时会进行配置校验。可以使用 debug 日志级别查看详细的配置加载信息：

```bash
TUNNOX_LOG_LEVEL=debug ./bin/server
```

#### Q: 多个配置来源冲突时如何处理？

A: 按照优先级合并：CLI 参数 > 环境变量 > .env 文件 > YAML 配置文件 > 默认值。高优先级的值会覆盖低优先级的值。

### B. 版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0 | 2025-12-29 | 初始版本 |

---

**文档结束**
