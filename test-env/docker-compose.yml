version: '3.8'

services:
  # MySQL - 用于 TCP 端口映射测试
  mysql:
    image: mysql:8.0
    container_name: test-mysql
    environment:
      MYSQL_ROOT_PASSWORD: test123
      MYSQL_DATABASE: testdb
    ports:
      - "13306:3306"
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 3s
      retries: 10

  # Redis - 用于 TCP 端口映射测试
  redis:
    image: redis:7-alpine
    container_name: test-redis
    ports:
      - "16379:6379"
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10

  # Nginx - 用于 HTTP/TCP 端口映射测试和 WebSocket 代理
  nginx:
    image: nginx:alpine
    container_name: test-nginx
    ports:
      - "18080:80"
    networks:
      - test-network
    volumes:
      - ./data/nginx.html:/usr/share/nginx/html/index.html:ro
      - ./data/tunnox.conf:/etc/nginx/conf.d/default.conf:ro
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 5s
      timeout: 3s
      retries: 10

  # DNS Server - 用于 UDP 端口映射测试
  dnsmasq:
    image: jpillora/dnsmasq
    container_name: test-dnsmasq
    ports:
      - "15353:53/udp"
    networks:
      - test-network
    environment:
      - "HTTP_USER=admin"
      - "HTTP_PASS=admin"

networks:
  test-network:
    driver: bridge

