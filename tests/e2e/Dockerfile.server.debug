# Debug版Dockerfile - 直接使用宿主机编译的二进制
FROM alpine:3.20

# 安装必要的运行时依赖
RUN apk add --no-cache ca-certificates wget

# 创建应用目录和用户
RUN addgroup -g 1000 tunnox && \
    adduser -D -u 1000 -G tunnox tunnox && \
    mkdir -p /app/data /app/config

# 设置工作目录
WORKDIR /app

# 直接从宿主机COPY编译好的Linux二进制（包含所有调试日志）
COPY ../../bin/tunnox-server-linux /app/tunnox-server

# 设置权限
RUN chown -R tunnox:tunnox /app && \
    chmod +x /app/tunnox-server

# 切换到非root用户
USER tunnox

# 暴露端口
EXPOSE 7000 7001 7002/udp 7003/udp 8080 9000

# 健康检查
HEALTHCHECK --interval=10s --timeout=5s --start-period=30s --retries=3 \
    CMD wget -q -O /dev/null http://localhost:9000/health || exit 1

# 运行服务器
ENTRYPOINT ["/app/tunnox-server"]

