user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 10000;
    use epoll;
}

stream {
    # TCP 负载均衡 (端口 7000 -> 后端 8080)
    upstream tunnox_tcp {
        # 负载均衡策略: least_conn (最少连接)
        least_conn;
        
        server tunnox-server-1:8080 max_fails=3 fail_timeout=30s;
        server tunnox-server-2:8080 max_fails=3 fail_timeout=30s;
        server tunnox-server-3:8080 max_fails=3 fail_timeout=30s;
    }

    server {
        listen 7000;
        proxy_pass tunnox_tcp;
        proxy_timeout 3600s;
        proxy_connect_timeout 10s;
    }

    # UDP 负载均衡 (端口 7002 -> 后端 8082)
    upstream tunnox_udp {
        # UDP 使用 hash 策略保证同一客户端到同一后端
        hash $remote_addr consistent;
        
        server tunnox-server-1:8082 max_fails=3 fail_timeout=30s;
        server tunnox-server-2:8082 max_fails=3 fail_timeout=30s;
        server tunnox-server-3:8082 max_fails=3 fail_timeout=30s;
    }

    server {
        listen 7002 udp;
        proxy_pass tunnox_udp;
        proxy_timeout 30s;
        proxy_responses 1;
    }

    # QUIC 负载均衡 (端口 7003 -> 后端 8083)
    upstream tunnox_quic {
        hash $remote_addr consistent;
        
        server tunnox-server-1:8083 max_fails=3 fail_timeout=30s;
        server tunnox-server-2:8083 max_fails=3 fail_timeout=30s;
        server tunnox-server-3:8083 max_fails=3 fail_timeout=30s;
    }

    server {
        listen 7003 udp;
        proxy_pass tunnox_quic;
        proxy_timeout 30s;
        proxy_responses 1;
    }
}

http {
    # WebSocket 负载均衡 (端口 7001 -> 后端 8081)
    upstream tunnox_ws {
        # WebSocket 需要保持连接，使用 ip_hash
        ip_hash;
        
        server tunnox-server-1:8081 max_fails=3 fail_timeout=30s;
        server tunnox-server-2:8081 max_fails=3 fail_timeout=30s;
        server tunnox-server-3:8081 max_fails=3 fail_timeout=30s;
    }

    server {
        listen 7001;
        
        location / {
            proxy_pass http://tunnox_ws;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_read_timeout 3600s;
        }
    }

    # Management API 负载均衡 (端口 8080，转发到后端的 9000)
    upstream tunnox_api {
        # API 使用轮询
        least_conn;
        
        server tunnox-server-1:9000 max_fails=3 fail_timeout=30s;
        server tunnox-server-2:9000 max_fails=3 fail_timeout=30s;
        server tunnox-server-3:9000 max_fails=3 fail_timeout=30s;
    }

    server {
        listen 8080;
        
        location / {
            proxy_pass http://tunnox_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # 健康检查端点不走负载均衡，直接返回
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}

