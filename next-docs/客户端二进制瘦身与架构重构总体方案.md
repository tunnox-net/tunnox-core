# Tunnox-Core å®¢æˆ·ç«¯äºŒè¿›åˆ¶ç˜¦èº«ä¸æ¶æ„é‡æ„æ€»ä½“æ–¹æ¡ˆ

> **æ–‡æ¡£ç‰ˆæœ¬**: v3.0
> **åˆ›å»ºæ—¥æœŸ**: 2025-12-26
> **æœ€åæ›´æ–°**: 2025-12-27
> **è§„èŒƒéµå¾ª**: `/docs/AI_CODING_RULES.md`
> **è®¾è®¡åŸåˆ™**: å½»åº•é‡æ„ï¼Œä¸åšä»»ä½•å…¼å®¹

---

## ä¸€ã€å½“å‰çŠ¶æ€è¯„ä¼°

### 1.1 å·²å®Œæˆå·¥ä½œ

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| httpservice ä¾èµ–è§£è€¦ | âœ… å®Œæˆ | å®¢æˆ·ç«¯ä¸å†ä¾èµ– httpservice |
| å®¢æˆ·ç«¯äºŒè¿›åˆ¶åˆæ­¥ç˜¦èº« | âœ… å®Œæˆ | 21MB â†’ 12MB |
| httptypes å…±äº«ç±»å‹åŒ… | âœ… å®Œæˆ | åˆ›å»º `protocol/httptypes` |

### 1.2 å¾…å®Œæˆå·¥ä½œ

| é¡¹ç›® | å½“å‰çŠ¶æ€ | é—®é¢˜ |
|------|---------|------|
| session åŒ…æ‹†åˆ† | âŒ æœªå¼€å§‹ | 13,010 è¡Œä»£ç ï¼Œ66 ä¸ªæ–‡ä»¶ï¼Œå…¨éƒ¨å¹³é“º |
| è¶…å¤§æ–‡ä»¶æ‹†åˆ† | âŒ æœªå¼€å§‹ | connection_lifecycle.go (595è¡Œ)ã€packet_handler_tunnel.go (556è¡Œ) |
| client åŒ…æ‹†åˆ† | âŒ æœªå¼€å§‹ | 5,901 è¡Œï¼Œ195% è¶…æ ‡ |
| storage åŒ…æ‹†åˆ† | âŒ æœªå¼€å§‹ | hybrid_storage.go å•æ–‡ä»¶è¿‡å¤§ |

### 1.3 å®¢æˆ·ç«¯ä¾èµ–ç°çŠ¶

å®¢æˆ·ç«¯å½“å‰ä¾èµ–çš„å†…éƒ¨åŒ…ï¼ˆå·²ç²¾ç®€ï¼‰ï¼š
```
tunnox-core/internal/client
tunnox-core/internal/client/cli
tunnox-core/internal/client/mapping
tunnox-core/internal/cloud/configs
tunnox-core/internal/cloud/constants
tunnox-core/internal/cloud/models
tunnox-core/internal/cloud/utils
tunnox-core/internal/config
tunnox-core/internal/constants
tunnox-core/internal/core/dispose
tunnox-core/internal/core/errors
tunnox-core/internal/core/log
tunnox-core/internal/packet
tunnox-core/internal/protocol/httptypes
tunnox-core/internal/stream
tunnox-core/internal/utils
tunnox-core/internal/version
```

**å…³é”®å‘ç°**: å®¢æˆ·ç«¯**ä¸ä¾èµ–** `protocol/session` åŒ…ï¼Œè¯¥åŒ…å¯ä½œä¸ºçº¯æœåŠ¡ç«¯æ¨¡å—é‡æ„ã€‚

---

## äºŒã€é‡æ„è®¾è®¡åŸåˆ™

### 2.1 æ ¸å¿ƒåŸåˆ™

1. **å½»åº•é‡æ„ï¼Œä¸åšå…¼å®¹**
   - âŒ ç¦æ­¢ä½¿ç”¨ç±»å‹åˆ«å `type X = pkg.X`
   - âŒ ç¦æ­¢åˆ›å»ºå¯¼å‡ºå±‚/å…¼å®¹å±‚
   - âœ… ç›´æ¥æ›´æ–°æ‰€æœ‰å¼•ç”¨è·¯å¾„

2. **ä¸¥æ ¼éµå¾ª AI_CODING_RULES.md**
   - å•æ–‡ä»¶ < 500 è¡Œ
   - å•åŒ… < 2000 è¡Œ
   - å•å‡½æ•° < 100 è¡Œ
   - ç¦æ­¢å¼±ç±»å‹

3. **å®¢æˆ·ç«¯é›¶è†¨èƒ€**
   - æœåŠ¡ç«¯ä¸“ç”¨ä»£ç æ”¾åœ¨ç‹¬ç«‹åŒ…
   - å®¢æˆ·ç«¯ä¸å¼•å…¥ä»»ä½•æœåŠ¡ç«¯ä»£ç 
   - å…±äº«ä»£ç å¿…é¡»è½»é‡

4. **å¤ç”¨ä¼˜å…ˆ**
   - ä¼˜å…ˆå¤ç”¨ `core/dispose`ã€`core/errors` ç­‰åŸºç¡€è®¾æ–½
   - å¤ç”¨ `cloud/models` å®šä¹‰çš„æ¨¡å‹
   - ä¸é‡å¤é€ è½®å­

---

## ä¸‰ã€session åŒ…å½»åº•é‡æ„

### 3.1 å½“å‰é—®é¢˜

```
internal/protocol/session/  (13,010 è¡Œï¼Œ66 æ–‡ä»¶)
â”œâ”€â”€ manager.go              # 445 è¡Œ - ä¼šè¯ç®¡ç†
â”œâ”€â”€ connection_lifecycle.go # 595 è¡Œ - ğŸ”´ è¶…æ ‡
â”œâ”€â”€ packet_handler_tunnel.go# 556 è¡Œ - ğŸ”´ è¶…æ ‡
â”œâ”€â”€ cross_node_pool.go      # 491 è¡Œ
â”œâ”€â”€ tunnel_buffer.go        # 482 è¡Œ
â”œâ”€â”€ http_proxy.go           # 429 è¡Œ
â”œâ”€â”€ ... å…¶ä»– 60 ä¸ªæ–‡ä»¶
```

**é—®é¢˜æ±‡æ€»**ï¼š
- åŒ…å¤§å° 13,010 è¡Œï¼Œè¶…æ ‡ 6.5 å€
- 2 ä¸ªæ–‡ä»¶è¶…è¿‡ 500 è¡Œé™åˆ¶
- èŒè´£æ··æ‚ï¼ˆè¿æ¥ã€éš§é“ã€è·¨èŠ‚ç‚¹ã€è¿ç§»ã€HTTPä»£ç†ï¼‰

### 3.2 æ–°æ¶æ„è®¾è®¡

**ç›®æ ‡**ï¼šå°† session åŒ…æ‹†åˆ†ä¸º 5 ä¸ªç‹¬ç«‹å­åŒ…ï¼Œæ¯ä¸ªåŒ…èŒè´£å•ä¸€ã€å¤§å°åˆè§„ã€‚

```
internal/protocol/
â”œâ”€â”€ conn/                    # è¿æ¥ç®¡ç† (~1,500 è¡Œ)
â”‚   â”œâ”€â”€ connection.go        # Connection ç»“æ„ä½“
â”‚   â”œâ”€â”€ interface.go         # è¿æ¥æ¥å£å®šä¹‰
â”‚   â”œâ”€â”€ factory.go           # è¿æ¥å·¥å‚
â”‚   â”œâ”€â”€ tcp.go               # TCP è¿æ¥å®ç°
â”‚   â”œâ”€â”€ managers.go          # è¿æ¥ç®¡ç†å™¨
â”‚   â””â”€â”€ state_store.go       # è¿æ¥çŠ¶æ€å­˜å‚¨
â”‚
â”œâ”€â”€ tunnel/                  # éš§é“ç®¡ç† (~1,800 è¡Œ)
â”‚   â”œâ”€â”€ bridge.go            # TunnelBridge æ ¸å¿ƒ
â”‚   â”œâ”€â”€ bridge_conn.go       # æ¡¥æ¥è¿æ¥ç®¡ç†
â”‚   â”œâ”€â”€ bridge_forward.go    # æ•°æ®è½¬å‘
â”‚   â”œâ”€â”€ buffer.go            # éš§é“ç¼“å†²
â”‚   â”œâ”€â”€ state.go             # éš§é“çŠ¶æ€
â”‚   â”œâ”€â”€ migration.go         # éš§é“è¿ç§»
â”‚   â””â”€â”€ registry.go          # éš§é“æ³¨å†Œè¡¨
â”‚
â”œâ”€â”€ crossnode/               # è·¨èŠ‚ç‚¹é€šä¿¡ (~1,600 è¡Œ)
â”‚   â”œâ”€â”€ pool.go              # è¿æ¥æ± 
â”‚   â”œâ”€â”€ listener.go          # ç›‘å¬å™¨
â”‚   â”œâ”€â”€ forward.go           # è½¬å‘é€»è¾‘
â”‚   â”œâ”€â”€ frame.go             # å¸§å¤„ç†
â”‚   â”œâ”€â”€ conn.go              # è·¨èŠ‚ç‚¹è¿æ¥
â”‚   â””â”€â”€ handler.go           # å¤„ç†å™¨
â”‚
â”œâ”€â”€ handlers/                # åè®®å¤„ç†å™¨ (~1,500 è¡Œ)
â”‚   â”œâ”€â”€ packet.go            # æ•°æ®åŒ…å¤„ç†å…¥å£
â”‚   â”œâ”€â”€ handshake.go         # æ¡æ‰‹å¤„ç†
â”‚   â”œâ”€â”€ tunnel.go            # éš§é“æ•°æ®å¤„ç†
â”‚   â”œâ”€â”€ http_proxy.go        # HTTP ä»£ç†
â”‚   â”œâ”€â”€ socks5.go            # SOCKS5 å¤„ç†
â”‚   â””â”€â”€ router.go            # è·¯ç”±åˆ†å‘
â”‚
â”œâ”€â”€ server/                  # æœåŠ¡ç«¯ä¼šè¯ç®¡ç† (~1,800 è¡Œ)
â”‚   â”œâ”€â”€ manager.go           # SessionManager æ ¸å¿ƒ
â”‚   â”œâ”€â”€ lifecycle.go         # è¿æ¥ç”Ÿå‘½å‘¨æœŸ
â”‚   â”œâ”€â”€ lifecycle_connect.go # è¿æ¥å»ºç«‹
â”‚   â”œâ”€â”€ lifecycle_close.go   # è¿æ¥å…³é—­
â”‚   â”œâ”€â”€ registry.go          # å®¢æˆ·ç«¯æ³¨å†Œè¡¨
â”‚   â”œâ”€â”€ shutdown.go          # ä¼˜é›…å…³é—­
â”‚   â”œâ”€â”€ notify.go            # äº‹ä»¶é€šçŸ¥
â”‚   â””â”€â”€ command.go           # å‘½ä»¤é›†æˆ
â”‚
â””â”€â”€ httptypes/               # HTTP ç±»å‹å®šä¹‰ (å·²å­˜åœ¨)
    â””â”€â”€ proxy.go
```

### 3.3 åŒ…èŒè´£å®šä¹‰

#### conn åŒ… - è¿æ¥ç®¡ç†
```go
// ä½ç½®: internal/protocol/conn/
// èŒè´£: è¿æ¥æŠ½è±¡å’Œç®¡ç†ï¼Œä¸å«ä¸šåŠ¡é€»è¾‘
// ä¾èµ–: core/dispose, core/errors

package conn

import (
    "context"
    "net"
    "tunnox-core/internal/core/dispose"
)

// Connection è¿æ¥ç»“æ„ä½“
// è§„èŒƒ: åµŒå…¥ dispose.Dispose
type Connection struct {
    dispose.Dispose

    ID       string
    ClientID int64
    Conn     net.Conn
    Protocol string
    // ...
}

// NewConnection åˆ›å»ºè¿æ¥
// è§„èŒƒ: parentCtx å¿…é¡»ä¼ å…¥
func NewConnection(parentCtx context.Context, conn net.Conn) *Connection {
    c := &Connection{Conn: conn}
    c.SetCtx(parentCtx, c.onClose)
    return c
}
```

#### tunnel åŒ… - éš§é“ç®¡ç†
```go
// ä½ç½®: internal/protocol/tunnel/
// èŒè´£: éš§é“æ¡¥æ¥å’Œæ•°æ®è½¬å‘
// ä¾èµ–: protocol/conn, core/dispose

package tunnel

// TunnelBridge éš§é“æ¡¥æ¥
// è§„èŒƒ: åµŒå…¥ dispose.ServiceBase
type TunnelBridge struct {
    *dispose.ServiceBase

    tunnelID    string
    sourceConn  *conn.Connection
    targetConn  *conn.Connection
    // ...
}
```

#### crossnode åŒ… - è·¨èŠ‚ç‚¹é€šä¿¡
```go
// ä½ç½®: internal/protocol/crossnode/
// èŒè´£: é›†ç¾¤èŠ‚ç‚¹é—´é€šä¿¡
// ä¾èµ–: protocol/conn, core/dispose

package crossnode

// CrossNodePool è·¨èŠ‚ç‚¹è¿æ¥æ± 
// è§„èŒƒ: åµŒå…¥ dispose.ManagerBase
type CrossNodePool struct {
    *dispose.ManagerBase

    nodePools sync.Map  // map[nodeID]*NodePool
    // ...
}
```

#### handlers åŒ… - åè®®å¤„ç†å™¨
```go
// ä½ç½®: internal/protocol/handlers/
// èŒè´£: æ•°æ®åŒ…å¤„ç†å’Œè·¯ç”±
// ä¾èµ–: protocol/conn, protocol/tunnel, packet

package handlers

// PacketHandler æ•°æ®åŒ…å¤„ç†å™¨
type PacketHandler struct {
    *dispose.ServiceBase

    tunnelHandler     *TunnelHandler
    handshakeHandler  *HandshakeHandler
    // ...
}
```

#### server åŒ… - æœåŠ¡ç«¯ä¼šè¯ç®¡ç†
```go
// ä½ç½®: internal/protocol/server/
// èŒè´£: ä¼šè¯ç”Ÿå‘½å‘¨æœŸç®¡ç†
// ä¾èµ–: protocol/conn, protocol/tunnel, protocol/handlers

package server

// SessionManager ä¼šè¯ç®¡ç†å™¨
// è§„èŒƒ: åµŒå…¥ dispose.ManagerBase
type SessionManager struct {
    *dispose.ManagerBase

    // ä¾èµ–æ³¨å…¥
    storage      storage.Storage
    bridgePool   *crossnode.CrossNodePool

    // å­ç®¡ç†å™¨
    connRegistry  *conn.Registry
    tunnelRegistry *tunnel.Registry
}

func NewSessionManager(
    parentCtx context.Context,
    storage storage.Storage,
) *SessionManager {
    return &SessionManager{
        ManagerBase: dispose.NewManager("SessionManager", parentCtx),
        storage:     storage,
    }
}
```

### 3.4 è¿ç§»æ˜ å°„è¡¨

| åŸæ–‡ä»¶ | ç›®æ ‡ä½ç½® | è¡Œæ•° | è¯´æ˜ |
|--------|---------|------|------|
| `connection.go` | `conn/connection.go` | 317 | ç›´æ¥ç§»åŠ¨ |
| `connection_interface.go` | `conn/interface.go` | 156 | ç›´æ¥ç§»åŠ¨ |
| `connection_managers.go` | `conn/managers.go` | 287 | ç›´æ¥ç§»åŠ¨ |
| `tcp_connection.go` | `conn/tcp.go` | 116 | ç›´æ¥ç§»åŠ¨ |
| `connection_factory.go` | `conn/factory.go` | 107 | ç›´æ¥ç§»åŠ¨ |
| `connection_state_store.go` | `conn/state_store.go` | 282 | ç›´æ¥ç§»åŠ¨ |
| `tunnel_bridge.go` | `tunnel/bridge.go` | 180 | ç›´æ¥ç§»åŠ¨ |
| `tunnel_bridge_*.go` | `tunnel/bridge_*.go` | ~400 | åˆå¹¶ç›¸å…³æ–‡ä»¶ |
| `tunnel_buffer.go` | `tunnel/buffer.go` | 482 | ç›´æ¥ç§»åŠ¨ |
| `tunnel_state.go` | `tunnel/state.go` | 224 | ç›´æ¥ç§»åŠ¨ |
| `tunnel_migration.go` | `tunnel/migration.go` | 269 | ç›´æ¥ç§»åŠ¨ |
| `tunnel_registry.go` | `tunnel/registry.go` | 114 | ç›´æ¥ç§»åŠ¨ |
| `cross_node_*.go` | `crossnode/*.go` | ~1,600 | æŒ‰åŠŸèƒ½æ‹†åˆ† |
| `packet_handler.go` | `handlers/packet.go` | 46 | ç›´æ¥ç§»åŠ¨ |
| `packet_handler_handshake.go` | `handlers/handshake.go` | 256 | ç›´æ¥ç§»åŠ¨ |
| `packet_handler_tunnel.go` | `handlers/tunnel.go` | 556 | ğŸ”´ éœ€æ‹†åˆ† |
| `http_proxy.go` | `handlers/http_proxy.go` | 429 | ç›´æ¥ç§»åŠ¨ |
| `socks5_tunnel_handler.go` | `handlers/socks5.go` | 174 | ç›´æ¥ç§»åŠ¨ |
| `packet_router.go` | `handlers/router.go` | 125 | ç›´æ¥ç§»åŠ¨ |
| `manager.go` | `server/manager.go` | 445 | ç›´æ¥ç§»åŠ¨ |
| `connection_lifecycle.go` | `server/lifecycle*.go` | 595 | ğŸ”´ éœ€æ‹†åˆ† |
| `client_registry.go` | `server/registry.go` | 308 | ç›´æ¥ç§»åŠ¨ |
| `shutdown.go` | `server/shutdown.go` | 206 | ç›´æ¥ç§»åŠ¨ |
| `manager_notify.go` | `server/notify.go` | 105 | ç›´æ¥ç§»åŠ¨ |
| `command_integration.go` | `server/command.go` | 288 | ç›´æ¥ç§»åŠ¨ |

### 3.5 è¶…å¤§æ–‡ä»¶æ‹†åˆ†æ–¹æ¡ˆ

#### connection_lifecycle.go (595 è¡Œ) â†’ æ‹†åˆ†ä¸º 3 ä¸ªæ–‡ä»¶

```
server/
â”œâ”€â”€ lifecycle.go           # ç”Ÿå‘½å‘¨æœŸæ ¸å¿ƒ (~200 è¡Œ)
â”‚   - ConnectionLifecycle ç»“æ„ä½“
â”‚   - ç”Ÿå‘½å‘¨æœŸçŠ¶æ€æœº
â”‚
â”œâ”€â”€ lifecycle_connect.go   # è¿æ¥å»ºç«‹ (~200 è¡Œ)
â”‚   - handleConnect()
â”‚   - æ¡æ‰‹éªŒè¯
â”‚   - è¿æ¥æ³¨å†Œ
â”‚
â””â”€â”€ lifecycle_close.go     # è¿æ¥å…³é—­ (~200 è¡Œ)
    - handleDisconnect()
    - èµ„æºæ¸…ç†
    - é€šçŸ¥è®¢é˜…è€…
```

#### packet_handler_tunnel.go (556 è¡Œ) â†’ æ‹†åˆ†ä¸º 2 ä¸ªæ–‡ä»¶

```
handlers/
â”œâ”€â”€ tunnel.go              # éš§é“æ•°æ®åŒ…å¤„ç† (~300 è¡Œ)
â”‚   - TunnelHandler ç»“æ„ä½“
â”‚   - handleTunnelData()
â”‚   - handleTunnelControl()
â”‚
â””â”€â”€ tunnel_routing.go      # éš§é“è·¯ç”±é€»è¾‘ (~260 è¡Œ)
    - routeToTarget()
    - routeToSource()
    - handleCrossNode()
```

---

## å››ã€client åŒ…é‡æ„

### 4.1 å½“å‰é—®é¢˜

```
internal/client/  (5,901 è¡Œï¼Œ32 æ–‡ä»¶)
â”œâ”€â”€ client.go              # ä¸»å®¢æˆ·ç«¯
â”œâ”€â”€ tunnel_pool.go         # è¿æ¥æ±  (å¤§æ–‡ä»¶)
â”œâ”€â”€ auto_connector.go      # è‡ªåŠ¨è¿æ¥
â”œâ”€â”€ mapping/               # æ˜ å°„ç®¡ç† (å·²æ‹†åˆ†)
â””â”€â”€ cli/                   # CLI å‘½ä»¤ (å·²æ‹†åˆ†)
```

### 4.2 æ–°æ¶æ„è®¾è®¡

```
internal/client/
â”œâ”€â”€ core/                  # å®¢æˆ·ç«¯æ ¸å¿ƒ (~1,500 è¡Œ)
â”‚   â”œâ”€â”€ client.go          # TunnoxClient ä¸»ç»“æ„
â”‚   â”œâ”€â”€ control.go         # æ§åˆ¶è¿æ¥ç®¡ç†
â”‚   â”œâ”€â”€ lifecycle.go       # ç”Ÿå‘½å‘¨æœŸç®¡ç†
â”‚   â””â”€â”€ config.go          # å®¢æˆ·ç«¯é…ç½®
â”‚
â”œâ”€â”€ tunnel/                # éš§é“å¤„ç† (~1,200 è¡Œ)
â”‚   â”œâ”€â”€ handler.go         # éš§é“å¤„ç†å™¨
â”‚   â”œâ”€â”€ target.go          # ç›®æ ‡ç«¯å¤„ç†
â”‚   â”œâ”€â”€ listen.go          # ç›‘å¬ç«¯å¤„ç†
â”‚   â””â”€â”€ forward.go         # æ•°æ®è½¬å‘
â”‚
â”œâ”€â”€ pool/                  # è¿æ¥æ±  (~800 è¡Œ)
â”‚   â”œâ”€â”€ pool.go            # è¿æ¥æ± ç®¡ç†
â”‚   â””â”€â”€ selector.go        # è¿æ¥é€‰æ‹©
â”‚
â”œâ”€â”€ connector/             # è‡ªåŠ¨è¿æ¥ (~600 è¡Œ)
â”‚   â”œâ”€â”€ auto.go            # è‡ªåŠ¨è¿æ¥å™¨
â”‚   â””â”€â”€ protocol.go        # åè®®é€‰æ‹©
â”‚
â”œâ”€â”€ proxy/                 # ä»£ç†åŠŸèƒ½ (~600 è¡Œ)
â”‚   â”œâ”€â”€ socks5.go          # SOCKS5 ä»£ç†
â”‚   â””â”€â”€ http.go            # HTTP ä»£ç†
â”‚
â”œâ”€â”€ mapping/               # æ˜ å°„ç®¡ç† (ä¿æŒç°çŠ¶)
â”‚
â””â”€â”€ cli/                   # CLI å‘½ä»¤ (ä¿æŒç°çŠ¶)
```

### 4.3 å…³é”®è®¾è®¡

```go
// internal/client/core/client.go
package core

// TunnoxClient å®¢æˆ·ç«¯æ ¸å¿ƒ
// è§„èŒƒ: åµŒå…¥ dispose.ManagerBase
type TunnoxClient struct {
    *dispose.ManagerBase

    // é…ç½®
    config *Config

    // å­ç»„ä»¶ (ä¾èµ–æ³¨å…¥)
    connector    *connector.AutoConnector
    tunnelPool   *pool.TunnelPool
    proxyHandler *proxy.Handler
}

func NewTunnoxClient(
    parentCtx context.Context,
    config *Config,
) *TunnoxClient {
    client := &TunnoxClient{
        ManagerBase: dispose.NewManager("TunnoxClient", parentCtx),
        config:      config,
    }

    // åˆå§‹åŒ–å­ç»„ä»¶ï¼Œä¼ é€’ client.Ctx()
    client.connector = connector.NewAutoConnector(client.Ctx(), config)
    client.tunnelPool = pool.NewTunnelPool(client.Ctx(), config)

    return client
}
```

---

## äº”ã€storage åŒ…é‡æ„

### 5.1 å½“å‰é—®é¢˜

- `hybrid_storage.go` æ–‡ä»¶è¿‡å¤§ï¼ˆéœ€ç¡®è®¤å®é™…è¡Œæ•°ï¼‰
- å®¢æˆ·ç«¯å¯èƒ½å¼•å…¥äº†ä¸å¿…è¦çš„å­˜å‚¨å®ç°

### 5.2 æ–°æ¶æ„è®¾è®¡

```
internal/core/storage/
â”œâ”€â”€ interface.go           # å­˜å‚¨æ¥å£å®šä¹‰ (~100 è¡Œ)
â”œâ”€â”€ factory.go             # å·¥å‚å‡½æ•° (~100 è¡Œ)
â”‚
â”œâ”€â”€ memory/                # å†…å­˜å­˜å‚¨ (å®¢æˆ·ç«¯å¯ç”¨)
â”‚   â””â”€â”€ storage.go         # (~400 è¡Œ)
â”‚
â”œâ”€â”€ json/                  # JSON å­˜å‚¨ (å®¢æˆ·ç«¯å¯ç”¨)
â”‚   â””â”€â”€ storage.go         # (~400 è¡Œ)
â”‚
â”œâ”€â”€ redis/                 # Redis å­˜å‚¨ (ä»…æœåŠ¡ç«¯)
â”‚   â””â”€â”€ storage.go         # (~500 è¡Œ)
â”‚
â””â”€â”€ hybrid/                # æ··åˆå­˜å‚¨ (ä»…æœåŠ¡ç«¯)
    â”œâ”€â”€ storage.go         # æ ¸å¿ƒå®ç° (~400 è¡Œ)
    â”œâ”€â”€ client_ops.go      # å®¢æˆ·ç«¯æ“ä½œ (~400 è¡Œ)
    â”œâ”€â”€ mapping_ops.go     # æ˜ å°„æ“ä½œ (~400 è¡Œ)
    â”œâ”€â”€ tunnel_ops.go      # éš§é“æ“ä½œ (~400 è¡Œ)
    â””â”€â”€ code_ops.go        # è¿æ¥ç æ“ä½œ (~400 è¡Œ)
```

### 5.3 å®¢æˆ·ç«¯éš”ç¦»

```go
// å®¢æˆ·ç«¯åªèƒ½ä½¿ç”¨ä»¥ä¸‹å­˜å‚¨ç±»å‹
import (
    "tunnox-core/internal/core/storage/memory"
    "tunnox-core/internal/core/storage/json"
)

// âŒ å®¢æˆ·ç«¯ç¦æ­¢å¼•ç”¨
// "tunnox-core/internal/core/storage/redis"
// "tunnox-core/internal/core/storage/hybrid"
```

---

## å…­ã€æ‰§è¡Œè®¡åˆ’

### é˜¶æ®µä¸€ï¼šsession åŒ…æ‹†åˆ†ï¼ˆä¼˜å…ˆçº§ P0ï¼‰

#### æ­¥éª¤ 1.1ï¼šåˆ›å»ºç›®å½•ç»“æ„

```bash
cd internal/protocol
mkdir -p conn tunnel crossnode handlers server
```

#### æ­¥éª¤ 1.2ï¼šè¿ç§» conn åŒ…

```bash
# ç§»åŠ¨æ–‡ä»¶
mv session/connection.go conn/
mv session/connection_interface.go conn/interface.go
mv session/connection_managers.go conn/managers.go
mv session/tcp_connection.go conn/tcp.go
mv session/connection_factory.go conn/factory.go
mv session/connection_state_store.go conn/state_store.go

# æ›´æ–°åŒ…å
sed -i '' 's/package session/package conn/' conn/*.go

# æ›´æ–°å†…éƒ¨å¼•ç”¨
# éœ€è¦æ‰‹åŠ¨æ£€æŸ¥å’Œæ›´æ–°
```

#### æ­¥éª¤ 1.3ï¼šè¿ç§» tunnel åŒ…

```bash
# ç§»åŠ¨æ–‡ä»¶
mv session/tunnel_bridge.go tunnel/bridge.go
mv session/tunnel_bridge_*.go tunnel/
mv session/tunnel_buffer.go tunnel/buffer.go
mv session/tunnel_state.go tunnel/state.go
mv session/tunnel_migration.go tunnel/migration.go
mv session/tunnel_migration_integration.go tunnel/migration_integration.go
mv session/tunnel_registry.go tunnel/registry.go
mv session/tunnel_routing.go tunnel/routing.go
mv session/tunnel_handler.go tunnel/handler.go

# æ›´æ–°åŒ…å
sed -i '' 's/package session/package tunnel/' tunnel/*.go
```

#### æ­¥éª¤ 1.4ï¼šè¿ç§» crossnode åŒ…

```bash
mv session/cross_node_*.go crossnode/
mv session/cross_server_*.go crossnode/
mv session/config_push_broadcast.go crossnode/

sed -i '' 's/package session/package crossnode/' crossnode/*.go
```

#### æ­¥éª¤ 1.5ï¼šè¿ç§» handlers åŒ…

```bash
mv session/packet_handler.go handlers/packet.go
mv session/packet_handler_handshake.go handlers/handshake.go
mv session/packet_handler_tunnel.go handlers/tunnel.go
mv session/packet_handler_helpers.go handlers/helpers.go
mv session/packet_router.go handlers/router.go
mv session/http_proxy.go handlers/http_proxy.go
mv session/socks5_tunnel_handler.go handlers/socks5.go

sed -i '' 's/package session/package handlers/' handlers/*.go
```

#### æ­¥éª¤ 1.6ï¼šè¿ç§» server åŒ…

```bash
mv session/manager.go server/
mv session/connection_lifecycle.go server/lifecycle.go
mv session/client_registry.go server/registry.go
mv session/shutdown.go server/
mv session/manager_notify.go server/notify.go
mv session/command_integration.go server/command.go
mv session/event_handlers.go server/events.go
mv session/response_manager.go server/response.go
mv session/cloudcontrol_adapter.go server/cloudcontrol.go
mv session/bridge_adapter.go server/bridge_adapter.go

sed -i '' 's/package session/package server/' server/*.go
```

#### æ­¥éª¤ 1.7ï¼šæ‹†åˆ†è¶…å¤§æ–‡ä»¶

**lifecycle.go æ‹†åˆ†**ï¼š
1. æå–è¿æ¥å»ºç«‹é€»è¾‘åˆ° `lifecycle_connect.go`
2. æå–è¿æ¥å…³é—­é€»è¾‘åˆ° `lifecycle_close.go`
3. ä¿ç•™æ ¸å¿ƒçŠ¶æ€æœºåœ¨ `lifecycle.go`

**tunnel.go æ‹†åˆ†**ï¼š
1. æå–è·¯ç”±é€»è¾‘åˆ° `tunnel_routing.go`
2. ä¿ç•™æ•°æ®å¤„ç†åœ¨ `tunnel.go`

#### æ­¥éª¤ 1.8ï¼šæ›´æ–°å…¨å±€å¼•ç”¨

```bash
#!/bin/bash
# update-imports.sh

# æŸ¥æ‰¾æ‰€æœ‰å¼•ç”¨ session åŒ…çš„æ–‡ä»¶
find . -name "*.go" -type f | while read file; do
    # æ›´æ–°å¼•ç”¨è·¯å¾„
    sed -i '' \
        -e 's|protocol/session|protocol/server|g' \
        -e 's|session\.SessionManager|server.SessionManager|g' \
        -e 's|session\.Connection|conn.Connection|g' \
        -e 's|session\.TunnelBridge|tunnel.TunnelBridge|g' \
        "$file"
done

# éªŒè¯ç¼–è¯‘
go build ./...
```

#### æ­¥éª¤ 1.9ï¼šåˆ é™¤åŸ session åŒ…

```bash
# ç¡®è®¤è¿ç§»å®Œæˆå
rm -rf internal/protocol/session/

# ä»…ä¿ç•™æµ‹è¯•æ–‡ä»¶ä¾›å‚è€ƒ
# æµ‹è¯•æ–‡ä»¶éœ€è¦åŒæ­¥è¿ç§»åˆ°å¯¹åº”å­åŒ…
```

### é˜¶æ®µäºŒï¼šclient åŒ…æ‹†åˆ†ï¼ˆä¼˜å…ˆçº§ P1ï¼‰

1. åˆ›å»º `client/core`ã€`client/tunnel`ã€`client/pool`ã€`client/connector`ã€`client/proxy` ç›®å½•
2. æŒ‰ç…§ä¸Šè¿°è®¾è®¡è¿ç§»æ–‡ä»¶
3. æ›´æ–°æ‰€æœ‰å¼•ç”¨
4. éªŒè¯å®¢æˆ·ç«¯äºŒè¿›åˆ¶å¤§å°ä¸å˜

### é˜¶æ®µä¸‰ï¼šstorage åŒ…æ‹†åˆ†ï¼ˆä¼˜å…ˆçº§ P2ï¼‰

1. å°† `hybrid_storage.go` æ‹†åˆ†ä¸ºå¤šä¸ªæ–‡ä»¶
2. ç¡®ä¿å®¢æˆ·ç«¯ä¸å¼•å…¥ redis/hybrid å­˜å‚¨
3. éªŒè¯å®¢æˆ·ç«¯äºŒè¿›åˆ¶å¤§å°

### é˜¶æ®µå››ï¼šéªŒè¯ä¸æ¸…ç†ï¼ˆä¼˜å…ˆçº§ P3ï¼‰

```bash
# 1. éªŒè¯ç¼–è¯‘
go build ./cmd/client
go build ./cmd/server

# 2. è¿è¡Œæµ‹è¯•
go test ./...

# 3. æ£€æŸ¥å®¢æˆ·ç«¯ä¾èµ–
go list -f '{{range .Deps}}{{println .}}{{end}}' ./cmd/client | grep tunnox

# 4. æ£€æŸ¥äºŒè¿›åˆ¶å¤§å°
ls -lh bin/client bin/server

# 5. æ£€æŸ¥åŒ…å¤§å°
find internal -type d -exec sh -c 'echo "$(find "{}" -maxdepth 1 -name "*.go" -not -name "*_test.go" | xargs wc -l 2>/dev/null | tail -1)" "{}"' \;
```

---

## ä¸ƒã€è§„èŒƒæ£€æŸ¥æ¸…å•

æ¯æ¬¡ä¿®æ”¹åå¿…é¡»æ£€æŸ¥ï¼š

- [ ] **Dispose ä½“ç³»**: æ‰€æœ‰ Manager åµŒå…¥ `*dispose.ManagerBase`ï¼Œæ‰€æœ‰ Service åµŒå…¥ `*dispose.ServiceBase`
- [ ] **Context ä¼ é€’**: å­ç»„ä»¶ä» `parent.Ctx()` æ´¾ç”Ÿï¼Œç¦æ­¢ `context.Background()`
- [ ] **ç±»å‹å®‰å…¨**: æ—  `interface{}`ã€`any`ã€`map[string]interface{}`
- [ ] **é”™è¯¯å¤„ç†**: ä½¿ç”¨ `coreerrors.New/Wrap`ï¼Œä¸å¿½ç•¥é”™è¯¯
- [ ] **æ–‡ä»¶å¤§å°**: å•æ–‡ä»¶ < 500 è¡Œ
- [ ] **åŒ…å¤§å°**: å•åŒ… < 2000 è¡Œ
- [ ] **å‡½æ•°å¤§å°**: å•å‡½æ•° < 100 è¡Œ
- [ ] **å‘½åè§„èŒƒ**: åŒ…åå°å†™ï¼Œæ–‡ä»¶åå°å†™ä¸‹åˆ’çº¿
- [ ] **ä¾èµ–æ³¨å…¥**: é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–
- [ ] **å®¢æˆ·ç«¯éš”ç¦»**: å®¢æˆ·ç«¯ä¸å¼•å…¥æœåŠ¡ç«¯ä¸“ç”¨åŒ…

---

## å…«ã€é¢„æœŸæ”¶ç›Š

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | æ”¹è¿› |
|------|--------|--------|------|
| session åŒ…å¤§å° | 13,010 è¡Œ | 5 ä¸ªåŒ…ï¼Œå„ < 2,000 è¡Œ | ç»“æ„æ¸…æ™° |
| è¶…æ ‡æ–‡ä»¶æ•° | 2 ä¸ª | 0 ä¸ª | å…¨éƒ¨åˆè§„ |
| client åŒ…å¤§å° | 5,901 è¡Œ | 6 ä¸ªåŒ…ï¼Œå„ < 1,500 è¡Œ | ç»“æ„æ¸…æ™° |
| å®¢æˆ·ç«¯äºŒè¿›åˆ¶ | 12 MB | â‰¤ 12 MB | ä¸å¢åŠ  |
| ä»£ç å¯ç»´æŠ¤æ€§ | å·® | ä¼˜ | èŒè´£å•ä¸€ |

---

## ä¹ã€é£é™©ä¸åº”å¯¹

| é£é™© | æ¦‚ç‡ | å½±å“ | åº”å¯¹æªæ–½ |
|------|------|------|---------|
| å¾ªç¯ä¾èµ– | ä¸­ | é«˜ | ä¸¥æ ¼åˆ†å±‚ï¼Œæ¥å£éš”ç¦» |
| é—æ¼å¼•ç”¨æ›´æ–° | ä¸­ | ä¸­ | ç¼–è¯‘éªŒè¯ï¼Œå…¨å±€æœç´¢ |
| æµ‹è¯•å¤±è´¥ | é«˜ | ä¸­ | é€æ­¥è¿ç§»ï¼Œä¿ç•™æµ‹è¯• |
| äºŒè¿›åˆ¶è†¨èƒ€ | ä½ | é«˜ | æ¯æ­¥éªŒè¯å¤§å° |

---

## é™„å½• Aï¼šæ–‡ä»¶è¿ç§»è¯¦ç»†æ¸…å•

### session åŒ…æ‰€æœ‰æ–‡ä»¶

```
session/
â”œâ”€â”€ bridge_adapter.go              â†’ server/bridge_adapter.go
â”œâ”€â”€ client_registry.go             â†’ server/registry.go
â”œâ”€â”€ client_registry_test.go        â†’ server/registry_test.go
â”œâ”€â”€ cloudcontrol_adapter.go        â†’ server/cloudcontrol.go
â”œâ”€â”€ command_integration.go         â†’ server/command.go
â”œâ”€â”€ config.go                      â†’ conn/config.go
â”œâ”€â”€ config_push_broadcast.go       â†’ crossnode/broadcast.go
â”œâ”€â”€ config_test.go                 â†’ conn/config_test.go
â”œâ”€â”€ connection.go                  â†’ conn/connection.go
â”œâ”€â”€ connection_cleanup_test.go     â†’ conn/cleanup_test.go
â”œâ”€â”€ connection_factory.go          â†’ conn/factory.go
â”œâ”€â”€ connection_interface.go        â†’ conn/interface.go
â”œâ”€â”€ connection_lifecycle.go        â†’ server/lifecycle.go (éœ€æ‹†åˆ†)
â”œâ”€â”€ connection_lifecycle_test.go   â†’ server/lifecycle_test.go
â”œâ”€â”€ connection_managers.go         â†’ conn/managers.go
â”œâ”€â”€ connection_state_store.go      â†’ conn/state_store.go
â”œâ”€â”€ cross_node_conn.go             â†’ crossnode/conn.go
â”œâ”€â”€ cross_node_forward.go          â†’ crossnode/forward.go
â”œâ”€â”€ cross_node_frame.go            â†’ crossnode/frame.go
â”œâ”€â”€ cross_node_listener.go         â†’ crossnode/listener.go
â”œâ”€â”€ cross_node_pool.go             â†’ crossnode/pool.go
â”œâ”€â”€ cross_server_handler.go        â†’ crossnode/handler.go
â”œâ”€â”€ cross_server_tunnel.go         â†’ crossnode/tunnel.go
â”œâ”€â”€ event_handlers.go              â†’ server/events.go
â”œâ”€â”€ http_proxy.go                  â†’ handlers/http_proxy.go
â”œâ”€â”€ http_proxy_test.go             â†’ handlers/http_proxy_test.go
â”œâ”€â”€ httppoll_priority_queue.go     â†’ handlers/httppoll_queue.go
â”œâ”€â”€ manager.go                     â†’ server/manager.go
â”œâ”€â”€ manager_notify.go              â†’ server/notify.go
â”œâ”€â”€ packet_handler.go              â†’ handlers/packet.go
â”œâ”€â”€ packet_handler_handshake.go    â†’ handlers/handshake.go
â”œâ”€â”€ packet_handler_helpers.go      â†’ handlers/helpers.go
â”œâ”€â”€ packet_handler_tunnel.go       â†’ handlers/tunnel.go (éœ€æ‹†åˆ†)
â”œâ”€â”€ packet_router.go               â†’ handlers/router.go
â”œâ”€â”€ packet_router_test.go          â†’ handlers/router_test.go
â”œâ”€â”€ response_manager.go            â†’ server/response.go
â”œâ”€â”€ server_bridge.go               â†’ server/bridge.go
â”œâ”€â”€ session.go                     â†’ server/session.go
â”œâ”€â”€ session_test.go                â†’ server/session_test.go
â”œâ”€â”€ shutdown.go                    â†’ server/shutdown.go
â”œâ”€â”€ shutdown_test.go               â†’ server/shutdown_test.go
â”œâ”€â”€ socks5_tunnel_handler.go       â†’ handlers/socks5.go
â”œâ”€â”€ tcp_connection.go              â†’ conn/tcp.go
â”œâ”€â”€ tunnel_bridge.go               â†’ tunnel/bridge.go
â”œâ”€â”€ tunnel_bridge_accessors.go     â†’ tunnel/bridge_accessors.go
â”œâ”€â”€ tunnel_bridge_connection.go    â†’ tunnel/bridge_conn.go
â”œâ”€â”€ tunnel_bridge_forward.go       â†’ tunnel/bridge_forward.go
â”œâ”€â”€ tunnel_bridge_interface.go     â†’ tunnel/interface.go
â”œâ”€â”€ tunnel_bridge_interfaces.go    â†’ tunnel/interfaces.go
â”œâ”€â”€ tunnel_bridge_start.go         â†’ tunnel/bridge_start.go
â”œâ”€â”€ tunnel_bridge_stats.go         â†’ tunnel/bridge_stats.go
â”œâ”€â”€ tunnel_buffer.go               â†’ tunnel/buffer.go
â”œâ”€â”€ tunnel_buffer_test.go          â†’ tunnel/buffer_test.go
â”œâ”€â”€ tunnel_handler.go              â†’ tunnel/handler.go
â”œâ”€â”€ tunnel_migration.go            â†’ tunnel/migration.go
â”œâ”€â”€ tunnel_migration_integration.go â†’ tunnel/migration_integration.go
â”œâ”€â”€ tunnel_migration_integration_test.go â†’ tunnel/migration_integration_test.go
â”œâ”€â”€ tunnel_migration_test.go       â†’ tunnel/migration_test.go
â”œâ”€â”€ tunnel_registry.go             â†’ tunnel/registry.go
â”œâ”€â”€ tunnel_registry_test.go        â†’ tunnel/registry_test.go
â”œâ”€â”€ tunnel_routing.go              â†’ tunnel/routing.go
â”œâ”€â”€ tunnel_routing_test.go         â†’ tunnel/routing_test.go
â”œâ”€â”€ tunnel_state.go                â†’ tunnel/state.go
â””â”€â”€ tunnel_state_test.go           â†’ tunnel/state_test.go
```
