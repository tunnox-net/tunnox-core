# Tunnox 配置指南文档大纲

**起草日期**: 2025-12-29
**文档目标**: `/Users/roger.tong/GolandProjects/tunnox/tunnox-core/docs/配置指南.md`
**设计原则**: 渐进式学习路径，从零配置到高级定制

---

## 一、文档结构大纲

### 第一章：快速开始（5 分钟上手）

**目标读者**: 新手、临时体验用户

1.1 零配置启动
- 服务端一键启动
- 客户端匿名模式
- 验证隧道连通性

1.2 第一个隧道
- TCP 端口映射示例
- 使用连接码建立隧道
- 查看隧道状态

### 第二章：客户端配置详解

**目标读者**: 个人开发者、日常使用

2.1 配置文件位置与优先级
- 三个搜索路径及优先级
- 推荐的配置文件放置位置
- 环境变量覆盖规则

2.2 快捷命令配置
- `tunnox http <port>` 命令详解
- `tunnox tcp <port>` 命令详解
- 自定义快捷命令别名

2.3 服务器连接配置
- 服务器地址设置
- 协议选择与自动切换
- 认证方式（匿名 vs Token）

2.4 隧道映射配置
- 端口映射语法
- 多隧道配置
- 映射标签与管理

2.5 流处理配置
- 压缩配置（级别 1-9）
- 加密配置（AES-256-GCM）
- 流量控制配置

### 第三章：服务端配置详解

**目标读者**: 自建服务、私有部署

3.1 基础配置
- 监听地址与端口
- 协议启用与配置
- 日志级别与输出

3.2 协议配置
- TCP 协议配置
- WebSocket 协议配置（含依赖说明）
- KCP 协议配置
- QUIC 协议配置

3.3 存储配置
- 内存模式（默认）
- 本地持久化模式
- Redis 集群模式
- 混合存储模式

3.4 HTTP 服务配置
- 域名代理功能配置
- 基础域名设置
- SSL/HTTPS 配置

3.5 管理 API 配置
- 监听地址
- 认证方式
- pprof 调试

### 第四章：生产环境部署

**目标读者**: DevOps、运维工程师

4.1 Systemd 集成
- 服务单元文件示例
- 日志收集配置
- 自动重启策略

4.2 Docker 部署
- Dockerfile 示例
- docker-compose 配置
- 环境变量配置清单

4.3 Kubernetes 部署
- Deployment 配置
- Service 配置
- ConfigMap 管理
- 健康检查配置

4.4 高可用配置
- Redis 集群模式
- 多节点部署
- 负载均衡配置

### 第五章：配置进阶

**目标读者**: 高级用户、定制需求

5.1 配置依赖关系
- HTTP 代理功能依赖图
- WebSocket 协议依赖图
- 集群模式依赖图

5.2 配置互斥规则
- 存储模式互斥说明
- 协议配置冲突处理

5.3 性能调优配置
- 连接池配置
- 缓冲区大小调整
- 并发限制配置

5.4 安全加固配置
- TLS 证书配置
- Token 认证配置
- IP 白名单配置

### 第六章：配置排错

**目标读者**: 遇到问题的所有用户

6.1 配置校验
- 启动前校验命令
- 常见校验错误

6.2 日志诊断
- 日志级别调整
- 关键日志解读

6.3 常见配置错误
- 端口冲突处理
- 权限问题排查
- 网络连通性检查

### 附录

A. 完整配置参考
- 服务端完整配置模板
- 客户端完整配置模板
- 所有配置项说明表

B. 环境变量对照表
- 服务端环境变量
- 客户端环境变量
- 优先级规则

C. 协议端口速查表
- 标准端口分配
- 自定义端口建议

---

## 二、每个章节的要点

### 第一章：快速开始

| 章节 | 关键要点 |
|------|---------|
| 1.1 零配置启动 | 强调"无需任何配置文件即可运行"，降低心理门槛 |
| 1.2 第一个隧道 | 使用最简单的 TCP 22 端口映射作为示例，展示完整流程 |

**注意事项**:
- 不要在快速开始章节引入过多概念
- 所有命令必须可直接复制执行
- 需要说明 `tunnox http` 当前依赖 base_domains 配置

### 第二章：客户端配置

| 章节 | 关键要点 |
|------|---------|
| 2.1 配置文件位置 | 明确三个搜索路径的优先级，推荐 ~/.tunnox/ 目录 |
| 2.2 快捷命令 | 说明 http/tcp/udp 命令的实际行为，特别是连接码模式 |
| 2.3 服务器连接 | 说明协议自动选择逻辑，失败后的回退机制 |
| 2.4 隧道映射 | 提供多种映射场景示例 |
| 2.5 流处理 | 说明压缩/加密的性能影响 |

**注意事项**:
- 配置文件搜索路径要用表格清晰展示
- 快捷命令与竞品差异要提前说明（连接码模式 vs 直接公网地址）

### 第三章：服务端配置

| 章节 | 关键要点 |
|------|---------|
| 3.1 基础配置 | 统一端口说明，消除文档与代码的不一致 |
| 3.2 协议配置 | 明确 WebSocket 依赖 HTTP 服务的关系 |
| 3.3 存储配置 | 说明三种模式的适用场景和互斥规则 |
| 3.4 HTTP 服务 | 重点说明 base_domains 配置，这是 `tunnox http` 的前提 |
| 3.5 管理 API | 说明安全考虑，生产环境建议 |

**注意事项**:
- 协议端口要统一使用代码默认值（TCP 8000, QUIC 8443）
- HTTP 代理功能缺失提示要明确

### 第四章：生产环境

| 章节 | 关键要点 |
|------|---------|
| 4.1 Systemd | 提供可直接使用的 unit 文件 |
| 4.2 Docker | 完整的 docker-compose 示例 |
| 4.3 K8s | 包含 liveness/readiness 探针配置说明 |
| 4.4 高可用 | Redis 集群模式的必要配置 |

**注意事项**:
- 需要说明健康检查端点当前不支持，建议方案
- 环境变量覆盖表要完整

### 第五章：配置进阶

| 章节 | 关键要点 |
|------|---------|
| 5.1 依赖关系 | 用图表展示配置项之间的依赖 |
| 5.2 互斥规则 | 明确说明哪些配置不能同时启用 |
| 5.3 性能调优 | 提供不同规模的推荐配置 |
| 5.4 安全加固 | 生产环境必须配置项清单 |

**注意事项**:
- 依赖关系图使用 Mermaid 或 ASCII art
- 互斥规则要有配置校验的错误提示示例

### 第六章：配置排错

| 章节 | 关键要点 |
|------|---------|
| 6.1 配置校验 | 介绍 config validate 命令（如已实现） |
| 6.2 日志诊断 | 关键日志关键词及含义 |
| 6.3 常见错误 | 真实用户会遇到的问题 |

---

## 三、配置示例清单

### 必须提供的配置示例

#### 客户端示例

| 示例名称 | 场景 | 文件名建议 |
|---------|------|-----------|
| 最小配置 | 仅连接服务器 | `client-minimal.yaml` |
| 开发环境 | 本地开发常用配置 | `client-dev.yaml` |
| 生产环境 | 完整安全配置 | `client-prod.yaml` |
| 多隧道 | 同时映射多个端口 | `client-multi-tunnel.yaml` |

#### 服务端示例

| 示例名称 | 场景 | 文件名建议 |
|---------|------|-----------|
| 零配置 | 默认启动，仅 TCP | `server-minimal.yaml` |
| 全协议 | 启用所有协议 | `server-full-protocol.yaml` |
| HTTP 代理 | 启用域名代理 | `server-http-proxy.yaml` |
| Redis 集群 | 多节点部署 | `server-cluster.yaml` |
| Docker | 容器化部署 | `server-docker.yaml` |
| K8s | Kubernetes 部署 | `server-k8s.yaml` |

#### Docker/K8s 示例

| 示例名称 | 场景 | 文件名建议 |
|---------|------|-----------|
| docker-compose | 单机容器部署 | `docker-compose.yaml` |
| docker-compose + redis | 带 Redis 的部署 | `docker-compose-redis.yaml` |
| K8s Deployment | K8s 部署清单 | `k8s-deployment.yaml` |
| K8s ConfigMap | 配置管理 | `k8s-configmap.yaml` |

### 示例内容要求

每个示例必须包含：
1. 文件头部注释说明用途
2. 每个配置项的行内注释
3. 可直接使用，无需修改（或明确标注需修改项）

---

## 四、FAQ 问题列表

### 快速开始类

| 问题 | 优先级 |
|------|--------|
| Q: 如何在没有配置文件的情况下启动？ | 高 |
| Q: 客户端如何连接到自己部署的服务端？ | 高 |
| Q: 如何验证隧道是否正常工作？ | 高 |
| Q: `tunnox http` 命令为什么没有显示公网地址？ | 高 |

### 配置文件类

| 问题 | 优先级 |
|------|--------|
| Q: 配置文件应该放在哪里？ | 高 |
| Q: 环境变量和配置文件哪个优先级更高？ | 中 |
| Q: 如何查看当前生效的配置？ | 中 |
| Q: 修改配置后需要重启吗？ | 中 |

### 协议类

| 问题 | 优先级 |
|------|--------|
| Q: 应该选择哪种协议？ | 高 |
| Q: WebSocket 协议为什么不能单独启用？ | 高 |
| Q: QUIC 协议需要什么前置条件？ | 中 |
| Q: 不同协议的默认端口是什么？ | 中 |

### 存储类

| 问题 | 优先级 |
|------|--------|
| Q: 重启后隧道配置会丢失吗？ | 高 |
| Q: 什么时候需要使用 Redis？ | 中 |
| Q: 本地持久化和 Redis 可以同时启用吗？ | 中 |

### 部署类

| 问题 | 优先级 |
|------|--------|
| Q: 如何在 Docker 中运行？ | 高 |
| Q: K8s 部署需要注意什么？ | 中 |
| Q: 如何配置健康检查？ | 中 |
| Q: 如何实现高可用部署？ | 低 |

### 故障排查类

| 问题 | 优先级 |
|------|--------|
| Q: 客户端连接不上服务端怎么办？ | 高 |
| Q: 端口映射不生效怎么排查？ | 高 |
| Q: 隧道频繁断开是什么原因？ | 中 |
| Q: 日志中出现 "XXX" 错误是什么意思？ | 中 |

### HTTP 代理类

| 问题 | 优先级 |
|------|--------|
| Q: 如何启用 HTTP 域名代理功能？ | 高 |
| Q: base_domains 应该配置什么？ | 高 |
| Q: 如何配置 HTTPS/SSL？ | 中 |
| Q: 如何使用自定义子域名？ | 低 |

---

## 五、写作规范

### 格式要求

1. **标题层级**: 最多使用 4 级标题
2. **代码块**: 所有配置示例使用 yaml 语法高亮
3. **命令行**: 使用 bash 语法高亮，带 $ 提示符
4. **表格**: 配置项说明使用表格，包含名称、类型、默认值、说明
5. **提示框**: 使用 Markdown 提示语法（> **注意**: ...）

### 内容要求

1. **可执行性**: 所有示例必须可直接复制执行
2. **完整性**: 每个配置项都要有说明
3. **准确性**: 配置值与代码默认值一致
4. **实用性**: 优先覆盖常见场景

### 已知问题说明

文档中需明确说明以下当前限制：

1. HTTP 代理功能需要手动配置 base_domains
2. 不支持配置热重载，修改配置需重启
3. 健康检查端点尚未实现
4. WebSocket 端口依赖 HTTP 服务端口

---

## 六、后续工作

### 文档编写顺序建议

1. **第一批（核心）**: 第一章 + 第二章 + 附录 A/B
2. **第二批（部署）**: 第三章 + 第四章
3. **第三批（进阶）**: 第五章 + 第六章 + FAQ

### 与代码改进的配合

| 文档章节 | 依赖的代码改进 |
|---------|---------------|
| 1.1 零配置启动 | 无 |
| 2.1 配置文件位置 | 建议添加 `--show-config-path` 命令 |
| 3.4 HTTP 服务 | 建议添加默认 base_domains |
| 4.3 K8s 部署 | 建议添加健康检查端点 |
| 6.1 配置校验 | 建议添加 `config validate` 命令 |

---

*大纲完成 - 产品经理视角*
