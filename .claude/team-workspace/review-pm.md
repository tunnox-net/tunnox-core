# 配置系统设计方案 - 产品经理评审报告

**评审人**: 通信产品经理
**评审日期**: 2025-12-29
**评审状态**: 有问题（需修改后通过）

---

## 一、总体评价

**总分: 75/100** - 整体设计框架完善，但存在影响用户体验的关键问题需要解决。

架构设计专业度高，技术方案成熟。但从用户视角看，部分设计偏重技术实现而忽略了用户真实使用场景，特别是在「首次使用体验」和「错误提示友好度」方面存在明显短板。

---

## 二、用户价值（保留）

### 2.1 零配置启动 - 极大降低上手门槛

**评价: 优秀**

- 服务端无需任何配置文件即可运行，这对新手极为友好
- 客户端匿名模式 `./client -anonymous` 一行命令即可连接
- 所有协议默认启用，用户无需关心协议细节

**建议保留并强化**: 在文档和命令行帮助中持续强调「无需配置即可体验」

### 2.2 多级配置来源 - 满足不同部署场景

**评价: 良好**

优先级设计合理：
```
CLI 参数 > 环境变量 > .env 文件 > YAML 配置 > 默认值
```

- Docker/K8s 用户可以纯环境变量配置，无需挂载配置文件
- 开发者可以用 `.env.local` 覆盖本地配置而不影响团队配置
- 生产环境可以用 YAML 管理复杂配置

**用户价值**: 一套配置系统适应从本地开发到 K8s 集群的全场景

### 2.3 Secret 类型 - 敏感信息保护

**评价: 优秀**

设计中的 `Secret` 类型解决了实际痛点：
- 日志输出自动脱敏 (`ab****yz`)
- YAML 序列化时自动脱敏
- 调试时不会意外泄露密码

**实际价值**: 减少生产事故风险，符合安全合规要求

### 2.4 配置验证与友好错误提示

**评价: 良好**

验证错误示例：
```
Configuration validation failed:

  1. server.protocols.tcp.port
     Current value: 80
     Error: port 80 requires root privileges
     Hint: Use a port >= 1024 or run as root
```

**价值**: 新手可以根据提示自行解决问题，减少求助成本

### 2.5 健康检查配置 - K8s 原生支持

**评价: 优秀**

```yaml
health:
  enabled: true
  listen: "0.0.0.0:9090"
  endpoints:
    liveness: "/healthz"
    readiness: "/ready"
```

**价值**: K8s 用户开箱即用，无需自行封装健康检查逻辑

---

## 三、问题/风险（需修改）

### 3.1 [严重] HTTP 代理功能配置门槛过高

**问题描述**:

`tunnox http <port>` 是核心使用场景（对标 ngrok/frp），但当前设计要求：
1. 服务端必须手动配置 `http.modules.domain_proxy.base_domains`
2. 没有任何默认值，用户不配置就无法使用

**影响范围**: 所有想使用 HTTP 域名代理功能的用户

**用户场景**:
```bash
# 用户期望（参考 ngrok）
$ tunnox http 3000
> Your tunnel is available at: https://abc123.tunnox.dev

# 实际情况
$ tunnox http 3000
> Error: domain_proxy.base_domains is not configured
```

**修改建议**:

| 方案 | 描述 | 推荐度 |
|-----|------|--------|
| A. 提供 SaaS 默认域名 | 默认使用 `*.tunnox.dev` | 高（需域名投入） |
| B. 自动生成本地域名 | 默认 `*.localhost.tunnox.local` | 中（仅开发环境可用） |
| C. 优化错误提示 | 清晰告知用户需要配置及配置方法 | 最低要求 |

### 3.2 [中等] 客户端 CLI 参数与配置文件不一致

**问题描述**:

Schema 文档定义客户端服务器地址为 `client.server.address`，但 CLAUDE.md 示例使用的是 `-s` 参数。两者的默认值不一致：
- Schema: `https://gw.tunnox.net/_tunnox`
- CLI 示例: `127.0.0.1:8000`

**用户困惑**: 到底连哪个？配置文件和命令行哪个优先？

**修改建议**:
1. 统一默认值（建议 CLI 不设默认值，强制用户指定）
2. 在配置指南中明确说明 CLI 参数与配置文件的对应关系
3. 添加 `tunnox config show` 命令显示当前生效配置

### 3.3 [中等] WebSocket 依赖 HTTP 服务未清晰说明

**问题描述**:

Schema 中提到：
```
server.protocols.websocket.enabled=true 依赖 http.enabled=true
```

但配置结构中 WebSocket 没有独立端口，这让用户困惑「WebSocket 到底监听在哪个端口？」

**修改建议**:
1. 在 WebSocket 配置区域添加注释说明它复用 HTTP 端口
2. 添加配置依赖检查，当 WebSocket 启用但 HTTP 未启用时给出明确错误

### 3.4 [中等] 端口冲突风险

**问题描述**:

默认配置：
- TCP: 8000
- KCP (UDP): 8000
- Management API: 9000
- HTTP: 9000
- Health: 9090

Management API 和 HTTP 都默认监听 9000，这会导致端口冲突。

**修改建议**:
1. Management API 与 HTTP 服务合并（如当前代码实现那样，都在 `/` 下）
2. 或者将 Management API 移到独立端口（如 9001）

### 3.5 [低] 配置热重载范围有限

**问题描述**:

仅 `log.level` 和 `rate_limit.*` 支持热重载，其他均需重启。这不算是缺陷，但需要在文档中明确说明。

**修改建议**:
- 在配置指南中添加「支持热重载的配置项」表格
- 热重载的配置项在 Schema 中用特殊标记标注

### 3.6 [低] 缺少配置迁移说明

**问题描述**:

对于从旧版本升级的用户，缺少配置迁移指南。当配置 Schema 变更时，如何帮助用户平滑迁移？

**修改建议**:
1. 添加配置版本号（如 `config_version: 1`）
2. 提供 `tunnox config migrate` 命令自动升级旧配置

---

## 四、场景覆盖度评估

### 4.1 已覆盖场景

| 场景 | 覆盖情况 | 评价 |
|------|---------|------|
| 本地开发调试 | 完全覆盖 | 零配置启动 + 匿名模式 |
| Docker 单机部署 | 完全覆盖 | 环境变量配置 |
| K8s 集群部署 | 完全覆盖 | 健康检查 + ConfigMap |
| 多节点高可用 | 完全覆盖 | Redis 存储 + 节点分配 |
| 安全合规环境 | 完全覆盖 | Secret 脱敏 + JWT 认证 |

### 4.2 遗漏/需补充场景

| 场景 | 问题 | 补充建议 |
|------|------|---------|
| Windows 开发者 | 配置路径仅说明 Linux/Mac | 补充 `%APPDATA%\tunnox\` 路径说明 |
| 企业代理环境 | 未提及 HTTP 代理配置 | 添加 `client.proxy.http_proxy` 配置项 |
| 离线部署 | 未提及离线激活方式 | 说明离线 License 配置（若有） |
| 多租户隔离 | 未提及租户配置 | Platform 模块需补充租户 ID 配置 |
| 防火墙穿透 | 未提及备用端口机制 | 说明端口回退策略配置 |

---

## 五、改进建议

### 5.1 必须改进（阻塞项）

1. **提供 HTTP 代理功能的默认体验**
   - 至少提供 `localhost.tunnox.local` 作为开发默认域名
   - 或提供清晰的错误提示引导用户配置

2. **统一端口默认值**
   - 解决 Management API 与 HTTP 端口冲突
   - 明确各端口的用途说明

### 5.2 建议改进（提升体验）

1. **添加诊断命令**
   ```bash
   tunnox config show      # 显示当前生效配置
   tunnox config validate  # 验证配置正确性
   tunnox config export    # 导出完整配置模板
   ```

2. **错误提示增强**
   - 端口被占用时提示具体占用进程
   - 配置缺失时提供 one-liner 修复命令

3. **配置指南优化**
   - 添加「5 分钟快速上手」视频/GIF 演示
   - FAQ 放在文档开头而非附录

### 5.3 长期改进（规划项）

1. **配置 WebUI**
   - 提供 `tunnox config edit` 打开图形化配置编辑器
   - 类似 `code .` 打开 VS Code

2. **配置模板市场**
   - 预置常见场景配置模板（游戏服务器、IoT 设备、远程桌面）

---

## 六、评审结论

**评审结果**: 有问题，需修改后通过

**必须修复项**:
1. HTTP 代理功能需提供开箱可用的默认体验或清晰的配置引导
2. 统一端口配置，解决 Management API 与 HTTP 端口冲突

**建议优化项**:
1. 添加 `tunnox config` 诊断命令系列
2. Windows 开发者配置路径说明
3. 客户端 HTTP 代理配置支持

---

**评审人签名**: 通信产品经理
**日期**: 2025-12-29
